import{d as x,r as f,o as C,z as N,D as B,E as t,f as n,B as a,L as w,a7 as h,C as m,J as E}from"./element-plus-40d2da59.js";const T={style:{padding:"20px"}},j=x({__name:"Subscribe",setup(W){let i=!1,u=null;const r=f("Enable Push Messaging"),c=f(!1),v=f(""),d=f(""),S=()=>{"serviceWorker"in navigator&&"PushManager"in window?(console.log("Service Worker and Push are supported"),navigator.serviceWorker.register("/sw.js").then(function(e){console.log("Service Worker is registered",e),u=e,k()}).catch(function(e){console.error("Service Worker Error",e)})):(console.warn("Push messaging is not supported"),r.value="Push Not Supported")},k=()=>{u.pushManager.getSubscription().then(function(e){i=e!==null,console.log(i?"User IS subscribed.":"User is NOT subscribed."),p()})},p=()=>{if(h.warning(Notification.permission),Notification.permission==="denied"){r.value="Push Messaging Blocked",c.value=!0,y(null);return}i?r.value="Disable Push Messaging":r.value="Enable Push Messaging",c.value=!1},y=e=>{e&&(v.value=JSON.stringify(e))},P=()=>{if(c.value=!0,i)V();else{if(!d.value)return h.warning("未设置applicationServerPublicKey");M()}},U=e=>{const s="=".repeat((4-e.length%4)%4),b=(e+s).replace(/\-/g,"+").replace(/_/g,"/"),o=window.atob(b),g=new Uint8Array(o.length);for(let l=0;l<o.length;++l)g[l]=o.charCodeAt(l);return g},M=()=>{const e=U(d.value);u.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e}).then(function(s){console.log("User is subscribed."),h.success("User is subscribed"),y(s),i=!0,p()}).catch(function(s){console.error("Failed to subscribe the user: ",s),h.error("Failed to subscribe the user: ",s),p()})};function V(){u.pushManager.getSubscription().then(function(e){if(e)return e.unsubscribe()}).catch(function(e){console.log("Error unsubscribing",e)}).then(function(){y(null),console.log("User is unsubscribed."),i=!1,p()})}return C(()=>{S()}),(e,s)=>{const b=m("el-input"),o=m("el-form-item"),g=m("el-button"),l=m("el-form");return N(),B("div",T,[s[2]||(s[2]=t("h1",null,"Push CodeLab",-1)),s[3]||(s[3]=t("p",null,"Welcome to the push messaging codelab. The button below needs to be fixed to support subscribing to push.",-1)),n(l,null,{default:a(()=>[n(o,{label:"公钥"},{default:a(()=>[n(b,{modelValue:d.value,"onUpdate:modelValue":s[0]||(s[0]=_=>d.value=_),type:"textarea",autosize:""},null,8,["modelValue"])]),_:1}),n(o,{label:"订阅"},{default:a(()=>[n(b,{modelValue:v.value,"onUpdate:modelValue":s[1]||(s[1]=_=>v.value=_),type:"textarea",autosize:""},null,8,["modelValue"])]),_:1}),n(o,{label:"操作"},{default:a(()=>[n(g,{type:"primary",disabled:c.value,onClick:P},{default:a(()=>[w(E(r.value),1)]),_:1},8,["disabled"])]),_:1})]),_:1}),s[4]||(s[4]=t("section",{class:"subscription-details js-subscription-details is-invisible"},[t("p",null,"Once you've subscribed your user, you'd send their subscription to your server to store in a database so that when you want to send a message you can lookup the subscription and send a message to it."),t("p",null,[w("To simplify things for this code lab copy the following details into the "),t("a",{href:"https://web-push-codelab.glitch.me//",target:"__blank"},"Push Companion Site"),w(" and it'll send a push message for you, using the application server keys on the site - so make sure they match.")]),t("pre",null,[t("code",{class:"js-subscription-json"})])],-1))])}}});export{j as default};
