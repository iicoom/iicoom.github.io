import{l as P}from"./index-d9998155.js";import{g as J}from"./index-8b747613.js";import{d as F,r as f,o as q,ap as z,a7 as G,z as w,D as O,E as i,f as s,B as a,F as R,C as u,L as l,G as K,A as W}from"./element-plus-b1d7f0ee.js";import"./echarts-71ab4440.js";const $={class:"my-4"},H={class:"py-6"},oe=F({__name:"WebRTC",setup(Q){const V=J(),m=f("");let r=null,v=null,t=null,p=[],d=null;const x={offerToReceiveAudio:1,offerToReceiveVideo:1},b={},A={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0,VoiceActivityDetection:!0}};q(()=>{V.userInfo._id,d=P(`http://localhost:3002?userId=${Math.random().toString(36).substr(2,9)}&room=1`),d.on("connect",()=>{console.log("connected")}),d.on("offerOrAnswer",o=>{console.log("offerOrAnswer",o),o.type==="offer"&&z.confirm("有人邀请你视频会议?","会议邀请",{confirmButtonText:"OK",cancelButtonText:"Cancel",type:"warning"}).then(()=>{k(o.sdp)}).catch(()=>{G({type:"info",message:"Delete canceled"})}),o.type==="answer"&&S(o.sdp)}),d.on("candidate",o=>{console.log("From Peer... ",o),p.push(JSON.parse(o))})});const I=async()=>{const o={audio:!0,video:{width:1280,height:720}};try{v=document.querySelector("#local-video"),r=await navigator.mediaDevices.getUserMedia(o),v.srcObject=r}catch(e){console.log(e)}},D=function(){const o=new RTCPeerConnection(b);return r&&r.getTracks().forEach(e=>{o.addTrack(e,r)}),o.ontrack=e=>{console.log("ontrack",e);const n=document.querySelector("#remote-video");n.srcObject=e.streams[0]},o.onicecandidate=e=>{console.log("===============onicecandidate"),e.candidate&&(console.log(JSON.stringify(e.candidate)),g("candidate",JSON.stringify(e.candidate)))},o.onicegatheringstatechange=()=>{console.log("ICE gathering state:",t.iceGatheringState)},o.oniceconnectionstatechange=()=>{console.log("ICE connection state:",t.iceConnectionState)},o},_=async()=>{t=D();const o=await t.createOffer(x);await t.setLocalDescription(o),m.value=JSON.stringify(o),g("offer",{type:"offer",sdp:o})},k=async o=>{t=D(),t.setRemoteDescription(new RTCSessionDescription(o));const e=await t.createAnswer(A);await t.setLocalDescription(e),g("answer",{type:"answer",sdp:e}),T()},g=(o,e)=>{d.emit(o,e)},S=o=>{t.setRemoteDescription(new RTCSessionDescription(o))},T=()=>{console.log("addCandidate",p);function o(e){console.error("Error:",e)}p.forEach(e=>{t.addIceCandidate(e).catch(o)})},B=()=>{t&&(t.close(),t=null),p=[],r.getTracks().forEach(o=>o.stop()),v.srcObject=null},y=f([]),E=f([]),h=async()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(o=>(console.log("Permissions granted"),r=o,navigator.mediaDevices.enumerateDevices())).then(o=>{console.log("Devices:",o),y.value=o.filter(e=>e.kind==="videoinput"),E.value=o.filter(e=>e.kind==="audioinput"),console.log("Video Devices:",y.value),console.log("Audio Devices:",E.value),r.getTracks().forEach(e=>e.stop())}).catch(o=>{console.error("Error accessing media devices.",o)})},C=f("");async function M(){const o=C.value;try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:o?{exact:o}:void 0},audio:!1}),n=document.getElementById("video");n.srcObject=e}catch(e){console.error("获取媒体设备时出错:",e)}}return(o,e)=>{const n=u("el-button"),N=u("el-input"),U=u("el-divider"),L=u("el-option"),j=u("el-select");return w(),O(R,null,[i("div",null,[e[8]||(e[8]=i("div",{class:"video-wrapper flex justify-center items-center"},[i("video",{id:"local-video",autoplay:"",class:"w-[calc(50%)]"}),i("video",{id:"remote-video",autoplay:"",class:"w-[calc(50%)]"})],-1)),i("div",$,[s(n,{onClick:S},{default:a(()=>e[2]||(e[2]=[l("setRemoteDescription")])),_:1}),s(n,{onClick:T},{default:a(()=>e[3]||(e[3]=[l("addCandidate")])),_:1}),s(n,{onClick:_},{default:a(()=>e[4]||(e[4]=[l("Call")])),_:1}),s(n,{onClick:k},{default:a(()=>e[5]||(e[5]=[l("Answer")])),_:1}),s(n,{onClick:B},{default:a(()=>e[6]||(e[6]=[l("hangUp")])),_:1}),s(n,{onClick:I},{default:a(()=>e[7]||(e[7]=[l("getLocalStream")])),_:1})]),s(N,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=c=>m.value=c),style:{width:"500px"},type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),i("div",H,[s(U,{"content-position":"left"},{default:a(()=>e[9]||(e[9]=[l("分割线")])),_:1})]),i("div",null,[e[12]||(e[12]=i("video",{src:"",id:"video",autoplay:"",playsinline:"",controls:"",class:"w-[calc(50%)]"},null,-1)),e[13]||(e[13]=i("h2",null,"选择摄像头",-1)),s(j,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=c=>C.value=c),placeholder:"Select",style:{width:"240px","margin-right":"10px"}},{default:a(()=>[(w(!0),O(R,null,K(y.value,c=>(w(),W(L,{key:c.deviceId,label:c.label,value:c.deviceId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(n,{onClick:h},{default:a(()=>e[10]||(e[10]=[l("获取")])),_:1}),s(n,{onClick:M},{default:a(()=>e[11]||(e[11]=[l("开始预览")])),_:1})])],64)}}});export{oe as default};
