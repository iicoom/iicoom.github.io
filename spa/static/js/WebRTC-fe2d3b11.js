import{l as ee}from"./index-d9998155.js";import{g as oe}from"./index-b38a4740.js";import{d as te,r as C,o as ne,ap as ce,a7 as ae,z as D,D as x,E as l,f as s,B as i,F as b,C as f,L as r,G as se,A as ie}from"./element-plus-40d2da59.js";import"./echarts-71ab4440.js";const le={class:"my-4"},re={class:"py-6"},me=te({__name:"WebRTC",setup(de){const _=oe(),h=C("");let d=null,w=null,a=null,m=[],g=null,t=null,n=null;const B={offerToReceiveAudio:1,offerToReceiveVideo:1};function p(o){return o===t?"pc1":"pc2"}function P(o){return o===t?n:t}const M={},j={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0,VoiceActivityDetection:!0}};ne(()=>{_.userInfo._id,g=ee(`http://localhost:3002?userId=${Math.random().toString(36).substr(2,9)}&room=1`),g.on("connect",()=>{console.log("connected")}),g.on("offerOrAnswer",o=>{console.log("offerOrAnswer",o),o.type==="offer"&&ce.confirm("有人邀请你视频会议?","会议邀请",{confirmButtonText:"OK",cancelButtonText:"Cancel",type:"warning"}).then(()=>{O(o.sdp)}).catch(()=>{ae({type:"info",message:"Delete canceled"})}),o.type==="answer"&&$(o.sdp)}),g.on("candidate",o=>{console.log("From Peer... ",o),m.push(JSON.parse(o))})});const N=async()=>{const o={audio:!0,video:{width:1280,height:720}};try{w=document.querySelector("#local-video"),d=await navigator.mediaDevices.getUserMedia(o),w.srcObject=d}catch(e){console.log(e)}},U=function(){const o=new RTCPeerConnection(M);return d&&d.getTracks().forEach(e=>{o.addTrack(e,d)}),o.ontrack=e=>{console.log("ontrack",e);const c=document.querySelector("#remote-video");c.srcObject=e.streams[0]},o.onicecandidate=e=>{console.log("===============onicecandidate"),e.candidate&&(console.log(JSON.stringify(e.candidate)),A("candidate",JSON.stringify(e.candidate)))},o.onicegatheringstatechange=()=>{console.log("ICE gathering state:",a.iceGatheringState)},o.oniceconnectionstatechange=()=>{console.log("ICE connection state:",a.iceConnectionState)},o.onconnectionstatechange=()=>{const e=o==null?void 0:o.connectionState;console.log(`peerConnection-onconnectionstatechange: ${e}`)},o},F=async()=>{const o={};console.log("RTCPeerConnection configuration:",o),t=new RTCPeerConnection(o),console.log("Created local peer connection object pc1"),t.addEventListener("icecandidate",e=>I(t,e)),t.addEventListener("iceconnectionstatechange",e=>T(t,e)),t.onconnectionstatechange=()=>{const e=t==null?void 0:t.connectionState;console.log(`pc1-onconnectionstatechange: ${e}`)},n=new RTCPeerConnection(o),console.log("Created remote peer connection object pc2"),n.addEventListener("icecandidate",e=>I(n,e)),n.addEventListener("iceconnectionstatechange",e=>T(n,e)),n.onconnectionstatechange=()=>{const e=n==null?void 0:n.connectionState;console.log(`pc2-onconnectionstatechange: ${e}`)};try{console.log("pc1 createOffer start");const e=await t.createOffer(B);await J(e)}catch(e){R(e)}};async function J(o){console.log(`Offer from pc1
${o.sdp}`),console.log("pc1 setLocalDescription start");try{await t.setLocalDescription(o),E(t)}catch{v()}console.log("pc2 setRemoteDescription start");try{await n.setRemoteDescription(o),k(n)}catch{v()}console.log("pc2 createAnswer start");try{const e=await n.createAnswer();await q(e)}catch(e){R(e)}}function E(o){console.log(`${p(o)} setLocalDescription complete`)}function R(o){console.log(`Failed to create session description: ${o.toString()}`)}function v(o){console.log(`Failed to set session description: ${o.toString()}`)}function k(o){console.log(`${p(o)} setRemoteDescription complete`)}async function q(o){console.log(`Answer from pc2:
${o.sdp}`),console.log("pc2 setLocalDescription start");try{await n.setLocalDescription(o),E(n)}catch(e){v(e)}console.log("pc1 setRemoteDescription start");try{await t.setRemoteDescription(o),k(t)}catch(e){v(e)}}async function I(o,e){try{await P(o).addIceCandidate(e.candidate),z(o)}catch(c){G(o,c)}console.log(`${p(o)} ICE candidate:
${e.candidate?e.candidate.candidate:"(null)"}`)}function z(o){console.log(`${p(o)} addIceCandidate success`)}function G(o,e){console.log(`${p(o)} failed to add ICE Candidate: ${e.toString()}`)}function T(o,e){o&&(console.log(`${p(o)} ICE state: ${o.iceConnectionState}`),console.log("ICE state change event: ",e))}const O=async o=>{a=U(),a.setRemoteDescription(new RTCSessionDescription(o));const e=await a.createAnswer(j);await a.setLocalDescription(e),A("answer",{type:"answer",sdp:e}),L()},A=(o,e)=>{g.emit(o,e)},$=o=>{a.setRemoteDescription(new RTCSessionDescription(o))},L=()=>{console.log("addCandidate",m);function o(e){console.error("Error:",e)}m.forEach(e=>{a.addIceCandidate(e).catch(o)})},K=()=>{a&&(a.close(),a=null),m=[],d.getTracks().forEach(o=>o.stop()),w.srcObject=null},y=C([]),V=C([]),W=async()=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(o=>(console.log("Permissions granted"),d=o,navigator.mediaDevices.enumerateDevices())).then(o=>{console.log("Devices:",o),y.value=o.filter(e=>e.kind==="videoinput"),V.value=o.filter(e=>e.kind==="audioinput"),console.log("Video Devices:",y.value),console.log("Audio Devices:",V.value),d.getTracks().forEach(e=>e.stop())}).catch(o=>{console.error("Error accessing media devices.",o)})},S=C("");async function H(){const o=S.value;try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:o?{exact:o}:void 0},audio:!1}),c=document.getElementById("video");c.srcObject=e}catch(e){console.error("获取媒体设备时出错:",e)}}return(o,e)=>{const c=f("el-button"),Q=f("el-input"),X=f("el-divider"),Y=f("el-option"),Z=f("el-select");return D(),x(b,null,[l("div",null,[e[8]||(e[8]=l("div",{class:"video-wrapper flex justify-center items-center"},[l("video",{id:"local-video",autoplay:"",class:"w-[calc(50%)]"}),l("video",{id:"remote-video",autoplay:"",class:"w-[calc(50%)]"})],-1)),l("div",le,[s(c,{onClick:$},{default:i(()=>e[2]||(e[2]=[r("setRemoteDescription")])),_:1}),s(c,{onClick:L},{default:i(()=>e[3]||(e[3]=[r("addCandidate")])),_:1}),s(c,{onClick:F},{default:i(()=>e[4]||(e[4]=[r("Call")])),_:1}),s(c,{onClick:O},{default:i(()=>e[5]||(e[5]=[r("Answer")])),_:1}),s(c,{onClick:K},{default:i(()=>e[6]||(e[6]=[r("hangUp")])),_:1}),s(c,{onClick:N},{default:i(()=>e[7]||(e[7]=[r("getLocalStream")])),_:1})]),s(Q,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=u=>h.value=u),style:{width:"500px"},type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),l("div",re,[s(X,{"content-position":"left"},{default:i(()=>e[9]||(e[9]=[r("分割线")])),_:1})]),l("div",null,[e[12]||(e[12]=l("video",{src:"",id:"video",autoplay:"",playsinline:"",controls:"",class:"w-[calc(50%)]"},null,-1)),e[13]||(e[13]=l("h2",null,"选择摄像头",-1)),s(Z,{modelValue:S.value,"onUpdate:modelValue":e[1]||(e[1]=u=>S.value=u),placeholder:"Select",style:{width:"240px","margin-right":"10px"}},{default:i(()=>[(D(!0),x(b,null,se(y.value,u=>(D(),ie(Y,{key:u.deviceId,label:u.label,value:u.deviceId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(c,{onClick:W},{default:i(()=>e[10]||(e[10]=[r("获取")])),_:1}),s(c,{onClick:H},{default:i(()=>e[11]||(e[11]=[r("开始预览")])),_:1})])],64)}}});export{me as default};
