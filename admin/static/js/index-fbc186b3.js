import{d as tr,o as Wr,r as ie,k as va,c as ba,C as ce,z as ge,A as cs,B as q,f as k,v as De,aC as Sa,D as Fe,G as On,E as V,J as Be,F as Xr,aR as kn,aS as jn,aT as $n,S as Js,L as ds,af as _,a7 as Ni,a as ya,q as Ra,al as Ca,X as Da,at as Ta,ac as Pa,aU as Ea}from"./element-plus-40d2da59.js";import{$ as ps,_ as Yr,g as La,G as ls}from"./index-842d9a02.js";import{M as Ma,a as xa}from"./MobileChat-1624e098.js";import{l as Nn}from"./index-d9998155.js";import{_ as Ia}from"./index-70b7a445.js";import"./echarts-71ab4440.js";import"./Tutorial-fad10d63.js";import"./BgAnimation-1ac95ae7.js";import"./index-a22f7fa8.js";import"./index-3871dfeb.js";import"./index-74c14a4e.js";import"./index-996c9a3b.js";const Oa=["onClick","onDblclick"],ka={key:0,class:"contact-card"},ja={class:"button-group"},$a=tr({__name:"Contact",setup(i){Wr(()=>{r()});const e=ie([]),t=va({name:""}),s=ba(()=>t.name?e.value.filter(d=>d.name.includes(t.name)):e.value);async function r(){const d={...t,page:1,limit:100},p=await ps.sendRequest("GetAdmins",d);e.value=p.list}async function n(d){const p={receiver_id:d._id},c=await ps.sendRequest("CreateConversation",p);console.log(c)}const a=ie(),o=d=>{console.log(d),a.value=d};return(d,p)=>{const c=ce("el-input"),u=ce("el-avatar"),l=ce("el-aside"),h=ce("el-icon"),f=ce("el-main"),g=ce("el-container");return ge(),cs(g,null,{default:q(()=>[k(l,{width:"300px",class:"contact-list"},{default:q(()=>[k(c,{modelValue:t.name,"onUpdate:modelValue":p[0]||(p[0]=m=>t.name=m),placeholder:"Search","prefix-icon":De(Sa),style:{"margin-bottom":"10px"}},null,8,["modelValue","prefix-icon"]),(ge(!0),Fe(Xr,null,On(s.value,(m,w)=>(ge(),Fe("div",{key:w,class:"contact-item",onClick:N=>o(m),onDblclick:N=>n(m)},[k(u,{size:50,src:m.avatar},null,8,["src"]),V("span",null,Be(m.name),1)],40,Oa))),128))]),_:1}),k(f,{style:{padding:"0"}},{default:q(()=>[a.value?(ge(),Fe("div",ka,[k(u,{size:50,src:a.value.avatar},null,8,["src"]),V("span",null,Be(a.value.name),1),V("div",ja,[k(h,{size:"25",onClick:p[1]||(p[1]=m=>n(a.value))},{default:q(()=>[k(De(kn))]),_:1}),k(h,{size:"25"},{default:q(()=>[k(De(jn))]),_:1}),k(h,{size:"25"},{default:q(()=>[k(De($n))]),_:1})])])):Js("",!0)]),_:1})]),_:1})}}});const Na=Yr($a,[["__scopeId","data-v-73f4e259"]]),Aa={style:{display:"flex","flex-direction":"column","align-items":"center",gap:"20px"}},Fa={class:"dialog-footer"},Ba={style:{display:"flex","flex-direction":"column","align-items":"center",gap:"20px"}},Ua={class:"dialog-footer"},za=tr({__name:"CallDialog",emits:["answer","hangup","hangupByCaller"],setup(i,{expose:e,emit:t}){const s=ie(!1),r=ie({}),n=ie(""),a=ie("https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png"),o=ie(!1),d=ie({}),p=t,c=(N,b)=>{r.value=N,n.value=b,s.value=!0},u=()=>{s.value=!1},l=()=>{p("answer",r.value),s.value=!1},h=()=>{p("hangup",r.value),s.value=!1},f={video:"视频通话",audio:"音频通话"},g=(N,b)=>{d.value=N,n.value=b,o.value=!0},m=()=>{p("hangupByCaller",d.value),o.value=!1};return e({showDialog:c,hideDialog:u,showCallDialog:g,hideCallDialog:()=>{o.value=!1}}),(N,b)=>{const E=ce("el-avatar"),K=ce("el-button"),ee=ce("el-dialog");return ge(),Fe(Xr,null,[k(ee,{modelValue:s.value,"onUpdate:modelValue":b[0]||(b[0]=ve=>s.value=ve),title:"",width:"500",center:"",draggable:"","close-on-press-escape":!1,"close-on-click-modal":!1,"show-close":!1},{footer:q(()=>[V("div",Fa,[k(K,{type:"danger",onClick:h},{default:q(()=>b[2]||(b[2]=[ds("挂断")])),_:1}),k(K,{type:"primary",onClick:l},{default:q(()=>b[3]||(b[3]=[ds(" 接听 ")])),_:1})])]),default:q(()=>[V("div",Aa,[k(E,{size:50,src:r.value.callerAvatar||a.value},null,8,["src"]),V("span",null,Be(r.value.callerName)+" 请求与你"+Be(f[n.value])+"... ",1)])]),_:1},8,["modelValue"]),k(ee,{modelValue:o.value,"onUpdate:modelValue":b[1]||(b[1]=ve=>o.value=ve),title:"",width:"500",center:"",draggable:"","close-on-press-escape":!1,"close-on-click-modal":!1,"show-close":!1},{footer:q(()=>[V("div",Ua,[k(K,{type:"danger",onClick:m},{default:q(()=>b[4]||(b[4]=[ds("挂断")])),_:1})])]),default:q(()=>[V("div",Ba,[k(E,{size:50,src:d.value.avatar||a.value},null,8,["src"]),V("span",null," 等待 "+Be(d.value.name)+" 接听... ",1)])]),_:1},8,["modelValue"])],64)}}});var An={},Vr={exports:{}},Or,Ai;function Ha(){if(Ai)return Or;Ai=1;var i=1e3,e=i*60,t=e*60,s=t*24,r=s*7,n=s*365.25;Or=function(c,u){u=u||{};var l=typeof c;if(l==="string"&&c.length>0)return a(c);if(l==="number"&&isFinite(c))return u.long?d(c):o(c);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(c))};function a(c){if(c=String(c),!(c.length>100)){var u=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(c);if(u){var l=parseFloat(u[1]),h=(u[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return l*n;case"weeks":case"week":case"w":return l*r;case"days":case"day":case"d":return l*s;case"hours":case"hour":case"hrs":case"hr":case"h":return l*t;case"minutes":case"minute":case"mins":case"min":case"m":return l*e;case"seconds":case"second":case"secs":case"sec":case"s":return l*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}}}function o(c){var u=Math.abs(c);return u>=s?Math.round(c/s)+"d":u>=t?Math.round(c/t)+"h":u>=e?Math.round(c/e)+"m":u>=i?Math.round(c/i)+"s":c+"ms"}function d(c){var u=Math.abs(c);return u>=s?p(c,u,s,"day"):u>=t?p(c,u,t,"hour"):u>=e?p(c,u,e,"minute"):u>=i?p(c,u,i,"second"):c+" ms"}function p(c,u,l,h){var f=u>=l*1.5;return Math.round(c/l)+" "+h+(f?"s":"")}return Or}function Ka(i){t.debug=t,t.default=t,t.coerce=d,t.disable=a,t.enable=r,t.enabled=o,t.humanize=Ha(),t.destroy=p,Object.keys(i).forEach(c=>{t[c]=i[c]}),t.names=[],t.skips=[],t.formatters={};function e(c){let u=0;for(let l=0;l<c.length;l++)u=(u<<5)-u+c.charCodeAt(l),u|=0;return t.colors[Math.abs(u)%t.colors.length]}t.selectColor=e;function t(c){let u,l=null,h,f;function g(...m){if(!g.enabled)return;const w=g,N=Number(new Date),b=N-(u||N);w.diff=b,w.prev=u,w.curr=N,u=N,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let E=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(ee,ve)=>{if(ee==="%%")return"%";E++;const Te=t.formatters[ve];if(typeof Te=="function"){const A=m[E];ee=Te.call(w,A),m.splice(E,1),E--}return ee}),t.formatArgs.call(w,m),(w.log||t.log).apply(w,m)}return g.namespace=c,g.useColors=t.useColors(),g.color=t.selectColor(c),g.extend=s,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(h!==t.namespaces&&(h=t.namespaces,f=t.enabled(c)),f),set:m=>{l=m}}),typeof t.init=="function"&&t.init(g),g}function s(c,u){const l=t(this.namespace+(typeof u>"u"?":":u)+c);return l.log=this.log,l}function r(c){t.save(c),t.namespaces=c,t.names=[],t.skips=[];const u=(typeof c=="string"?c:"").trim().replace(" ",",").split(",").filter(Boolean);for(const l of u)l[0]==="-"?t.skips.push(l.slice(1)):t.names.push(l)}function n(c,u){let l=0,h=0,f=-1,g=0;for(;l<c.length;)if(h<u.length&&(u[h]===c[l]||u[h]==="*"))u[h]==="*"?(f=h,g=l,h++):(l++,h++);else if(f!==-1)h=f+1,g++,l=g;else return!1;for(;h<u.length&&u[h]==="*";)h++;return h===u.length}function a(){const c=[...t.names,...t.skips.map(u=>"-"+u)].join(",");return t.enable(""),c}function o(c){for(const u of t.skips)if(n(c,u))return!1;for(const u of t.names)if(n(c,u))return!0;return!1}function d(c){return c instanceof Error?c.stack||c.message:c}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var Ga=Ka;(function(i,e){e.formatArgs=s,e.save=r,e.load=n,e.useColors=t,e.storage=a(),e.destroy=(()=>{let d=!1;return()=>{d||(d=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function t(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let d;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(d=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(d[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(d){if(d[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+d[0]+(this.useColors?"%c ":" ")+"+"+i.exports.humanize(this.diff),!this.useColors)return;const p="color: "+this.color;d.splice(1,0,p,"color: inherit");let c=0,u=0;d[0].replace(/%[a-zA-Z%]/g,l=>{l!=="%%"&&(c++,l==="%c"&&(u=c))}),d.splice(u,0,p)}e.log=console.debug||console.log||(()=>{});function r(d){try{d?e.storage.setItem("debug",d):e.storage.removeItem("debug")}catch{}}function n(){let d;try{d=e.storage.getItem("debug")}catch{}return!d&&typeof process<"u"&&"env"in process&&(d={}.DEBUG),d}function a(){try{return localStorage}catch{}}i.exports=Ga(e);const{formatters:o}=i.exports;o.j=function(d){try{return JSON.stringify(d)}catch(p){return"[UnexpectedJSONParseError]: "+p.message}}})(Vr,Vr.exports);var sr=Vr.exports,Ut={},qr={exports:{}};(function(i,e){(function(t,s){var r="2.0.0",n="",a="?",o="function",d="undefined",p="object",c="string",u="major",l="model",h="name",f="type",g="vendor",m="version",w="architecture",N="console",b="mobile",E="tablet",K="smarttv",ee="wearable",ve="xr",Te="embedded",A="inapp",C="user-agent",W=500,he="brands",be="formFactors",qt="fullVersionList",Ye="platform",Qt="platformVersion",mt="bitness",Ee="sec-ch-ua",yr=Ee+"-full-version-list",re=Ee+"-arch",Rr=Ee+"-"+mt,Ps=Ee+"-form-factors",Es=Ee+"-"+b,_i=Ee+"-"+l,wi=Ee+"-"+Ye,ua=wi+"-version",vi=[he,qt,b,l,Ye,Qt,w,be,mt],Se="browser",Ke="cpu",Le="device",Ge="engine",Re="os",gt="result",Ls="Amazon",Wt="Apple",bi="ASUS",Si="BlackBerry",pt="Google",yi="Huawei",Ri="Lenovo",ha="Honor",Cr="LG",Ms="Microsoft",Ci="Motorola",Xt="Samsung",Di="Sharp",xs="Sony",Dr="Xiaomi",Tr="Zebra",_t="Mobile ",Yt=" Browser",Ti="Chrome",Je="Chromecast",fa="Edge",Jt="Firefox",Zt="Opera",Pi="Facebook",Ei="Sogou",Pr="Windows",Li=typeof t!==d,_e=Li&&t.navigator?t.navigator:s,Ze=_e&&_e.userAgentData?_e.userAgentData:s,ma=function(v,S){var y={},H=S;if(!Os(S)){H={};for(var M in S)for(var Z in S[M])H[Z]=S[M][Z].concat(H[Z]?H[Z]:[])}for(var R in v)y[R]=H[R]&&H[R].length%2===0?H[R].concat(v[R]):v[R];return y},Is=function(v){for(var S={},y=0;y<v.length;y++)S[v[y].toUpperCase()]=v[y];return S},Er=function(v,S){if(typeof v===p&&v.length>0){for(var y in v)if(Ve(v[y])==Ve(S))return!0;return!1}return wt(v)?Ve(S).indexOf(Ve(v))!==-1:!1},Os=function(v,S){for(var y in v)return/^(browser|cpu|device|engine|os)$/.test(y)||(S?Os(v[y]):!1)},wt=function(v){return typeof v===c},Lr=function(v){if(!v)return s;for(var S=[],y=lt(/\\?\"/g,v).split(","),H=0;H<y.length;H++)if(y[H].indexOf(";")>-1){var M=ts(y[H]).split(";v=");S[H]={brand:M[0],version:M[1]}}else S[H]=ts(y[H]);return S},Ve=function(v){return wt(v)?v.toLowerCase():v},Mr=function(v){return wt(v)?lt(/[^\d\.]/g,v).split(".")[0]:s},qe=function(v){for(var S in v){var y=v[S];typeof y==p&&y.length==2?this[y[0]]=y[1]:this[y]=s}return this},lt=function(v,S){return wt(S)?S.replace(v,n):S},es=function(v){return lt(/\\?\"/g,v)},ts=function(v,S){if(wt(v))return v=lt(/^\s\s*/,v),typeof S===d?v:v.substring(0,W)},Mi=function(v,S){if(!(!v||!S))for(var y=0,H,M,Z,R,Q,$;y<S.length&&!Q;){var le=S[y],et=S[y+1];for(H=M=0;H<le.length&&!Q&&le[H];)if(Q=le[H++].exec(v),Q)for(Z=0;Z<et.length;Z++)$=Q[++M],R=et[Z],typeof R===p&&R.length>0?R.length===2?typeof R[1]==o?this[R[0]]=R[1].call(this,$):this[R[0]]=R[1]:R.length===3?typeof R[1]===o&&!(R[1].exec&&R[1].test)?this[R[0]]=$?R[1].call(this,$,R[2]):s:this[R[0]]=$?$.replace(R[1],R[2]):s:R.length===4&&(this[R[0]]=$?R[3].call(this,$.replace(R[1],R[2])):s):this[R]=$||s;y+=2}},ss=function(v,S){for(var y in S)if(typeof S[y]===p&&S[y].length>0){for(var H=0;H<S[y].length;H++)if(Er(S[y][H],v))return y===a?s:y}else if(Er(S[y],v))return y===a?s:y;return S.hasOwnProperty("*")?S["*"]:v},xi={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Ii={embedded:"Automotive",mobile:"Mobile",tablet:["Tablet","EInk"],smarttv:"TV",wearable:"Watch",xr:["VR","XR"],"?":["Desktop","Unknown"],"*":s},Oi={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[m,[h,_t+"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[m,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,m],[/opios[\/ ]+([\w\.]+)/i],[m,[h,Zt+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[m,[h,Zt+" GX"]],[/\bopr\/([\w\.]+)/i],[m,[h,Zt]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[m,[h,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[m,[h,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,m],[/quark(?:pc)?\/([-\w\.]+)/i],[m,[h,"Quark"]],[/\bddg\/([\w\.]+)/i],[m,[h,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[m,[h,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[m,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[m,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[m,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[m,[h,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[m,[h,"Smart "+Ri+Yt]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure"+Yt],m],[/\bfocus\/([\w\.]+)/i],[m,[h,Jt+" Focus"]],[/\bopt\/([\w\.]+)/i],[m,[h,Zt+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[m,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[m,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[m,[h,Zt+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[m,[h,"MIUI"+Yt]],[/fxios\/([\w\.-]+)/i],[m,[h,_t+Jt]],[/\bqihoobrowser\/?([\w\.]*)/i],[m,[h,"360"]],[/\b(qq)\/([\w\.]+)/i],[[h,/(.+)/,"$1Browser"],m],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1"+Yt],m],[/samsungbrowser\/([\w\.]+)/i],[m,[h,Xt+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[m,[h,Ei+" Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[h,Ei+" Mobile"],m],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[h,m],[/(lbbrowser|rekonq)/i],[h],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[m,h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,Pi],m,[f,A]],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(instagram|snapchat)[\/ ]([-\w\.]+)/i],[h,m,[f,A]],[/\bgsa\/([\w\.]+) .*safari\//i],[m,[h,"GSA"],[f,A]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[m,[h,"TikTok"],[f,A]],[/\[(linkedin)app\]/i],[h,[f,A]],[/(chromium)[\/ ]([-\w\.]+)/i],[h,m],[/headlesschrome(?:\/([\w\.]+)| )/i],[m,[h,Ti+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,Ti+" WebView"],m],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[m,[h,"Android"+Yt]],[/chrome\/([\w\.]+) mobile/i],[m,[h,_t+"Chrome"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,m],[/version\/([\w\.\,]+) .*mobile(?:\/\w+ | ?)safari/i],[m,[h,_t+"Safari"]],[/iphone .*mobile(?:\/\w+ | ?)safari/i],[[h,_t+"Safari"]],[/version\/([\w\.\,]+) .*(safari)/i],[m,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[m,"1"]],[/(webkit|khtml)\/([\w\.]+)/i],[h,m],[/(?:mobile|tablet);.*(firefox)\/([\w\.-]+)/i],[[h,_t+Jt],m],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],m],[/(wolvic|librewolf)\/([\w\.]+)/i],[h,m],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[m,[h,Jt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[h,[m,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[h,[m,/[^\d\.]+./,n]]],cpu:[[/\b(?:(amd|x|x86[-_]?|wow|win)64)\b/i],[[w,"amd64"]],[/(ia32(?=;))/i,/((?:i[346]|x)86)[;\)]/i],[[w,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[w,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[w,"armhf"]],[/windows (ce|mobile); ppc;/i],[[w,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[w,/ower/,n,Ve]],[/(sun4\w)[;\)]/i],[[w,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[w,Ve]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[g,Xt],[f,E]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[l,[g,Xt],[f,b]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[l,[g,Wt],[f,b]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[g,Wt],[f,E]],[/(macintosh);/i],[l,[g,Wt]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[g,Di],[f,b]],[/(?:honor)([-\w ]+)[;\)]/i],[l,[g,ha],[f,b]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[g,yi],[f,E]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[l,[g,yi],[f,b]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i],[[l,/_/g," "],[g,Dr],[f,b]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[g,Dr],[f,E]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[g,"OPPO"],[f,b]],[/\b(opd2\d{3}a?) bui/i],[l,[g,"OPPO"],[f,E]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[g,"Vivo"],[f,b]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[l,[g,"Realme"],[f,b]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[g,Ci],[f,b]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[g,Ci],[f,E]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[g,Cr],[f,E]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[g,Cr],[f,b]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[g,Ri],[f,E]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[g,"Nokia"],[f,b]],[/(pixel c)\b/i],[l,[g,pt],[f,E]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[g,pt],[f,b]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[g,xs],[f,b]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[g,xs],[f,E]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[g,"OnePlus"],[f,b]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[g,Ls],[f,E]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[g,Ls],[f,b]],[/(playbook);[-\w\),; ]+(rim)/i],[l,g,[f,E]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[g,Si],[f,b]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[g,bi],[f,E]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[g,bi],[f,b]],[/(nexus 9)/i],[l,[g,"HTC"],[f,E]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[g,[l,/_/g," "],[f,b]],[/tcl (xess p17aa)/i,/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])(_\w(\w|\w\w))?(\)| bui)/i],[l,[g,"TCL"],[f,E]],[/droid [\w\.]+; (418(?:7d|8v)|5087z|5102l|61(?:02[dh]|25[adfh]|27[ai]|56[dh]|59k|65[ah])|a509dl|t(?:43(?:0w|1[adepqu])|50(?:6d|7[adju])|6(?:09dl|10k|12b|71[efho]|76[hjk])|7(?:66[ahju]|67[hw]|7[045][bh]|71[hk]|73o|76[ho]|79w|81[hks]?|82h|90[bhsy]|99b)|810[hs]))(_\w(\w|\w\w))?(\)| bui)/i],[l,[g,"TCL"],[f,b]],[/(itel) ((\w+))/i],[[g,Ve],l,[f,ss,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[g,"Acer"],[f,E]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[g,"Meizu"],[f,b]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[l,[g,"Ulefone"],[f,b]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[l,[g,"Energizer"],[f,b]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[l,[g,"Cat"],[f,b]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[l,[g,"Smartfren"],[f,b]],[/droid.+; (a(?:015|06[35]|142p?))/i],[l,[g,"Nothing"],[f,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (imo) ((?!tab)[\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[g,l,[f,b]],[/(imo) (tab \w+)/i,/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i],[g,l,[f,E]],[/(surface duo)/i],[l,[g,Ms],[f,E]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[g,"Fairphone"],[f,b]],[/(shield[\w ]+) b/i],[l,[g,"Nvidia"],[f,E]],[/(sprint) (\w+)/i],[g,l,[f,b]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[g,Ms],[f,b]],[/droid.+; ([c6]+|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[g,Tr],[f,E]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[g,Tr],[f,b]],[/smart-tv.+(samsung)/i],[g,[f,K]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[g,Xt],[f,K]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[g,Cr],[f,K]],[/(apple) ?tv/i],[g,[l,Wt+" TV"],[f,K]],[/crkey.*devicetype\/chromecast/i],[[l,Je+" Third Generation"],[g,pt],[f,K]],[/crkey.*devicetype\/([^/]*)/i],[[l,/^/,"Chromecast "],[g,pt],[f,K]],[/fuchsia.*crkey/i],[[l,Je+" Nest Hub"],[g,pt],[f,K]],[/crkey/i],[[l,Je],[g,pt],[f,K]],[/droid.+aft(\w+)( bui|\))/i],[l,[g,Ls],[f,K]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[l,[g,Di],[f,K]],[/(bravia[\w ]+)( bui|\))/i],[l,[g,xs],[f,K]],[/(mitv-\w{5}) bui/i],[l,[g,Dr],[f,K]],[/Hbbtv.*(technisat) (.*);/i],[g,l,[f,K]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[g,ts],[l,ts],[f,K]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[f,K]],[/(ouya)/i,/(nintendo) (\w+)/i],[g,l,[f,N]],[/droid.+; (shield) bui/i],[l,[g,"Nvidia"],[f,N]],[/(playstation \w+)/i],[l,[g,xs],[f,N]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[g,Ms],[f,N]],[/\b(sm-[lr]\d\d[05][fnuw]?s?)\b/i],[l,[g,Xt],[f,ee]],[/((pebble))app/i],[g,l,[f,ee]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[l,[g,Wt],[f,ee]],[/droid.+; (wt63?0{2,3})\)/i],[l,[g,Tr],[f,ee]],[/droid.+; (glass) \d/i],[l,[g,pt],[f,ve]],[/(pico) (4|neo3(?: link|pro)?)/i],[g,l,[f,ve]],[/; (quest( \d| pro)?)/i],[l,[g,Pi],[f,ve]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[g,[f,Te]],[/(aeobc)\b/i],[l,[g,Ls],[f,Te]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[l,[f,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[f,E]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[f,E]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[f,b]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[g,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[m,[h,fa+"HTML"]],[/(arkweb)\/([\w\.]+)/i],[h,m],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[m,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,m],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[m,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,m],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[h,[m,ss,xi]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[m,ss,xi],[h,Pr]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[m,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,"macOS"],[m,/_/g,"."]],[/android ([\d\.]+).*crkey/i],[m,[h,Je+" Android"]],[/fuchsia.*crkey\/([\d\.]+)/i],[m,[h,Je+" Fuchsia"]],[/crkey\/([\d\.]+).*devicetype\/smartspeaker/i],[m,[h,Je+" SmartSpeaker"]],[/linux.*crkey\/([\d\.]+)/i],[m,[h,Je+" Linux"]],[/crkey\/([\d\.]+)/i],[m,[h,Je]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[m,h],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish|openharmony)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[h,m],[/\(bb(10);/i],[m,[h,Si]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[m,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[m,[h,Jt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[m,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[m,[h,"watchOS"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,"Chrome OS"],m],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) (\w+)/i,/(xbox); +xbox ([^\);]+)/i,/(pico) .+os([\w\.]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,m],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],m],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,m]]},ks=function(){var v={init:{},isIgnore:{},isIgnoreRgx:{},toString:{}};return qe.call(v.init,[[Se,[h,m,u,f]],[Ke,[w]],[Le,[f,l,g]],[Ge,[h,m]],[Re,[h,m]]]),qe.call(v.isIgnore,[[Se,[m,u]],[Ge,[m]],[Re,[m]]]),qe.call(v.isIgnoreRgx,[[Se,/ ?browser$/i],[Re,/ ?os$/i]]),qe.call(v.toString,[[Se,[h,m]],[Ke,[w]],[Le,[g,l]],[Ge,[h,m]],[Re,[h,m]]]),v}(),ga=function(v,S){var y=ks.init[S],H=ks.isIgnore[S]||0,M=ks.isIgnoreRgx[S]||0,Z=ks.toString[S]||0;function R(){qe.call(this,y)}return R.prototype.getItem=function(){return v},R.prototype.withClientHints=function(){return Ze?Ze.getHighEntropyValues(vi).then(function(Q){return v.setCH(new ki(Q,!1)).parseCH().get()}):v.parseCH().get()},R.prototype.withFeatureCheck=function(){return v.detectFeature().get()},S!=gt&&(R.prototype.is=function(Q){var $=!1;for(var le in this)if(this.hasOwnProperty(le)&&!Er(H,le)&&Ve(M?lt(M,this[le]):this[le])==Ve(M?lt(M,Q):Q)){if($=!0,Q!=d)break}else if(Q==d&&$){$=!$;break}return $},R.prototype.toString=function(){var Q=n;for(var $ in Z)typeof this[Z[$]]!==d&&(Q+=(Q?" ":n)+this[Z[$]]);return Q||d}),Ze||(R.prototype.then=function(Q){var $=this,le=function(){for(var tt in $)$.hasOwnProperty(tt)&&(this[tt]=$[tt])};le.prototype={is:R.prototype.is,toString:R.prototype.toString};var et=new le;return Q(et),et}),new R};function ki(v,S){if(v=v||{},qe.call(this,vi),S)qe.call(this,[[he,Lr(v[Ee])],[qt,Lr(v[yr])],[b,/\?1/.test(v[Es])],[l,es(v[_i])],[Ye,es(v[wi])],[Qt,es(v[ua])],[w,es(v[re])],[be,Lr(v[Ps])],[mt,es(v[Rr])]]);else for(var y in v)this.hasOwnProperty(y)&&typeof v[y]!==d&&(this[y]=v[y])}function ji(v,S,y,H){return this.get=function(M){return M?this.data.hasOwnProperty(M)?this.data[M]:s:this.data},this.set=function(M,Z){return this.data[M]=Z,this},this.setCH=function(M){return this.uaCH=M,this},this.detectFeature=function(){if(_e&&_e.userAgent==this.ua)switch(this.itemType){case Se:_e.brave&&typeof _e.brave.isBrave==o&&this.set(h,"Brave");break;case Le:!this.get(f)&&Ze&&Ze[b]&&this.set(f,b),this.get(l)=="Macintosh"&&_e&&typeof _e.standalone!==d&&_e.maxTouchPoints&&_e.maxTouchPoints>2&&this.set(l,"iPad").set(f,E);break;case Re:!this.get(h)&&Ze&&Ze[Ye]&&this.set(h,Ze[Ye]);break;case gt:var M=this.data,Z=function(R){return M[R].getItem().detectFeature().get()};this.set(Se,Z(Se)).set(Ke,Z(Ke)).set(Le,Z(Le)).set(Ge,Z(Ge)).set(Re,Z(Re))}return this},this.parseUA=function(){return this.itemType!=gt&&Mi.call(this.data,this.ua,this.rgxMap),this.itemType==Se&&this.set(u,Mr(this.get(m))),this},this.parseCH=function(){var M=this.uaCH,Z=this.rgxMap;switch(this.itemType){case Se:var R=M[qt]||M[he],Q;if(R)for(var $ in R){var le=lt(/(Google|Microsoft) /,R[$].brand||R[$]),et=R[$].version;!/not.a.brand/i.test(le)&&(!Q||/chrom/i.test(Q)&&!/chromi/i.test(le))&&(this.set(h,le).set(m,et).set(u,Mr(et)),Q=le)}break;case Ke:var tt=M[w];tt&&(tt&&M[mt]=="64"&&(tt+="64"),Mi.call(this.data,tt+";",Z));break;case Le:if(M[b]&&this.set(f,b),M[l]&&this.set(l,M[l]),M[l]=="Xbox"&&this.set(f,N).set(g,Ms),M[be]){var $s;if(typeof M[be]!="string")for(var $i=0;!$s&&$i<M[be].length;)$s=ss(M[be][$i++],Ii);else $s=ss(M[be],Ii);this.set(f,$s)}break;case Re:var xr=M[Ye];if(xr){var Ir=M[Qt];xr==Pr&&(Ir=parseInt(Mr(Ir),10)>=13?"11":"10"),this.set(h,xr).set(m,Ir)}this.get(h)==Pr&&M[l]=="Xbox"&&this.set(h,"Xbox").set(m,s);break;case gt:var _a=this.data,rs=function(wa){return _a[wa].getItem().setCH(M).parseCH().get()};this.set(Se,rs(Se)).set(Ke,rs(Ke)).set(Le,rs(Le)).set(Ge,rs(Ge)).set(Re,rs(Re))}return this},qe.call(this,[["itemType",v],["ua",S],["uaCH",H],["rgxMap",y],["data",ga(this,v)]]),this}function Pe(v,S,y){if(typeof v===p?(Os(v,!0)?(typeof S===p&&(y=S),S=v):(y=v,S=s),v=s):typeof v===c&&!Os(S,!0)&&(y=S,S=s),y&&typeof y.append===o){var H={};y.forEach(function($,le){H[le]=$}),y=H}if(!(this instanceof Pe))return new Pe(v,S,y).getResult();var M=typeof v===c?v:y&&y[C]?y[C]:_e&&_e.userAgent?_e.userAgent:n,Z=new ki(y,!0),R=S?ma(Oi,S):Oi,Q=function($){return $==gt?function(){return new ji($,M,R,Z).set("ua",M).set(Se,this.getBrowser()).set(Ke,this.getCPU()).set(Le,this.getDevice()).set(Ge,this.getEngine()).set(Re,this.getOS()).get()}:function(){return new ji($,M,R[$],Z).parseUA().get()}};return qe.call(this,[["getBrowser",Q(Se)],["getCPU",Q(Ke)],["getDevice",Q(Le)],["getEngine",Q(Ge)],["getOS",Q(Re)],["getResult",Q(gt)],["getUA",function(){return M}],["setUA",function($){return wt($)&&(M=$.length>W?ts($,W):$),this}]]).setUA(M),this}Pe.VERSION=r,Pe.BROWSER=Is([h,m,u,f]),Pe.CPU=Is([w]),Pe.DEVICE=Is([l,g,f,N,b,K,E,ee,Te]),Pe.ENGINE=Pe.OS=Is([h,m]),i.exports&&(e=i.exports=Pe),e.UAParser=Pe;var vt=Li&&(t.jQuery||t.Zepto);if(vt&&!vt.ua){var js=new Pe;vt.ua=js.getResult(),vt.ua.get=function(){return js.getUA()},vt.ua.set=function(v){js.setUA(v);var S=js.getResult();for(var y in S)vt.ua[y]=S[y]}}})(typeof window=="object"?window:_)})(qr,qr.exports);var Va=qr.exports,te={},qa=_&&_.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(te,"__esModule",{value:!0});te.Logger=void 0;const bt=qa(sr),St="mediasoup-client";let Qa=class{constructor(e){e?(this._debug=(0,bt.default)(`${St}:${e}`),this._warn=(0,bt.default)(`${St}:WARN:${e}`),this._error=(0,bt.default)(`${St}:ERROR:${e}`)):(this._debug=(0,bt.default)(St),this._warn=(0,bt.default)(`${St}:WARN`),this._error=(0,bt.default)(`${St}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};te.Logger=Qa;var Ue={},Jr={exports:{}},Ft=typeof Reflect=="object"?Reflect:null,Fi=Ft&&typeof Ft.apply=="function"?Ft.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},Zs;Ft&&typeof Ft.ownKeys=="function"?Zs=Ft.ownKeys:Object.getOwnPropertySymbols?Zs=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Zs=function(e){return Object.getOwnPropertyNames(e)};function Wa(i){console&&console.warn&&console.warn(i)}var Fn=Number.isNaN||function(e){return e!==e};function X(){X.init.call(this)}Jr.exports=X;Jr.exports.once=Za;X.EventEmitter=X;X.prototype._events=void 0;X.prototype._eventsCount=0;X.prototype._maxListeners=void 0;var Bi=10;function rr(i){if(typeof i!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i)}Object.defineProperty(X,"defaultMaxListeners",{enumerable:!0,get:function(){return Bi},set:function(i){if(typeof i!="number"||i<0||Fn(i))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+i+".");Bi=i}});X.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};X.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Fn(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Bn(i){return i._maxListeners===void 0?X.defaultMaxListeners:i._maxListeners}X.prototype.getMaxListeners=function(){return Bn(this)};X.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var r=e==="error",n=this._events;if(n!==void 0)r=r&&n.error===void 0;else if(!r)return!1;if(r){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var d=n[e];if(d===void 0)return!1;if(typeof d=="function")Fi(d,this,t);else for(var p=d.length,c=Gn(d,p),s=0;s<p;++s)Fi(c[s],this,t);return!0};function Un(i,e,t,s){var r,n,a;if(rr(t),n=i._events,n===void 0?(n=i._events=Object.create(null),i._eventsCount=0):(n.newListener!==void 0&&(i.emit("newListener",e,t.listener?t.listener:t),n=i._events),a=n[e]),a===void 0)a=n[e]=t,++i._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),r=Bn(i),r>0&&a.length>r&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=i,o.type=e,o.count=a.length,Wa(o)}return i}X.prototype.addListener=function(e,t){return Un(this,e,t,!1)};X.prototype.on=X.prototype.addListener;X.prototype.prependListener=function(e,t){return Un(this,e,t,!0)};function Xa(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function zn(i,e,t){var s={fired:!1,wrapFn:void 0,target:i,type:e,listener:t},r=Xa.bind(s);return r.listener=t,s.wrapFn=r,r}X.prototype.once=function(e,t){return rr(t),this.on(e,zn(this,e,t)),this};X.prototype.prependOnceListener=function(e,t){return rr(t),this.prependListener(e,zn(this,e,t)),this};X.prototype.removeListener=function(e,t){var s,r,n,a,o;if(rr(t),r=this._events,r===void 0)return this;if(s=r[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(n=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,n=a;break}if(n<0)return this;n===0?s.shift():Ya(s,n),s.length===1&&(r[e]=s[0]),r.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};X.prototype.off=X.prototype.removeListener;X.prototype.removeAllListeners=function(e){var t,s,r;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var n=Object.keys(s),a;for(r=0;r<n.length;++r)a=n[r],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function Hn(i,e,t){var s=i._events;if(s===void 0)return[];var r=s[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?Ja(r):Gn(r,r.length)}X.prototype.listeners=function(e){return Hn(this,e,!0)};X.prototype.rawListeners=function(e){return Hn(this,e,!1)};X.listenerCount=function(i,e){return typeof i.listenerCount=="function"?i.listenerCount(e):Kn.call(i,e)};X.prototype.listenerCount=Kn;function Kn(i){var e=this._events;if(e!==void 0){var t=e[i];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}X.prototype.eventNames=function(){return this._eventsCount>0?Zs(this._events):[]};function Gn(i,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=i[s];return t}function Ya(i,e){for(;e+1<i.length;e++)i[e]=i[e+1];i.pop()}function Ja(i){for(var e=new Array(i.length),t=0;t<e.length;++t)e[t]=i[t].listener||i[t];return e}function Za(i,e){return new Promise(function(t,s){function r(a){i.removeListener(e,n),s(a)}function n(){typeof i.removeListener=="function"&&i.removeListener("error",r),t([].slice.call(arguments))}Vn(i,e,n,{once:!0}),e!=="error"&&eo(i,r,{once:!0})})}function eo(i,e,t){typeof i.on=="function"&&Vn(i,"error",e,t)}function Vn(i,e,t,s){if(typeof i.on=="function")s.once?i.once(e,t):i.on(e,t);else if(typeof i.addEventListener=="function")i.addEventListener(e,function r(n){s.once&&i.removeEventListener(e,r),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof i)}var to=Jr.exports;Object.defineProperty(Ue,"__esModule",{value:!0});Ue.EnhancedEventEmitter=void 0;const so=to,ro=te,io=new ro.Logger("EnhancedEventEmitter");class no extends so.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){try{return super.emit(e,...t)}catch(s){io.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,s);try{super.emit("listenererror",e,s)}catch{}return!!super.listenerCount(e)}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}}Ue.EnhancedEventEmitter=no;var de={};Object.defineProperty(de,"__esModule",{value:!0});de.InvalidStateError=de.UnsupportedError=void 0;class Zr extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Zr):this.stack=new Error(e).stack}}de.UnsupportedError=Zr;class ei extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,ei):this.stack=new Error(e).stack}}de.InvalidStateError=ei;var ae={};Object.defineProperty(ae,"__esModule",{value:!0});ae.clone=ao;ae.generateRandomNumber=oo;ae.deepFreeze=qn;function ao(i){if(i!==void 0)return Number.isNaN(i)?NaN:typeof structuredClone=="function"?structuredClone(i):JSON.parse(JSON.stringify(i))}function oo(){return Math.round(Math.random()*1e7)}function qn(i){const e=Reflect.ownKeys(i);for(const t of e){const s=i[t];(s&&typeof s=="object"||typeof s=="function")&&qn(s)}return Object.freeze(i)}var J={},ne={},ir={},co=_&&_.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ir,"__esModule",{value:!0});ir.Logger=void 0;const yt=co(sr),Rt="h264-profile-level-id";let po=class{constructor(e){e?(this._debug=(0,yt.default)(`${Rt}:${e}`),this._warn=(0,yt.default)(`${Rt}:WARN:${e}`),this._error=(0,yt.default)(`${Rt}:ERROR:${e}`)):(this._debug=(0,yt.default)(Rt),this._warn=(0,yt.default)(`${Rt}:WARN`),this._error=(0,yt.default)(`${Rt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};ir.Logger=po;Object.defineProperty(ne,"__esModule",{value:!0});ne.generateProfileLevelIdStringForAnswer=ne.isSameProfile=ne.parseSdpProfileLevelId=ne.levelToString=ne.profileToString=ne.profileLevelIdToString=ne.parseProfileLevelId=ne.ProfileLevelId=ne.Level=ne.Profile=void 0;const lo=ir,dt=new lo.Logger;var Y;(function(i){i[i.ConstrainedBaseline=1]="ConstrainedBaseline",i[i.Baseline=2]="Baseline",i[i.Main=3]="Main",i[i.ConstrainedHigh=4]="ConstrainedHigh",i[i.High=5]="High",i[i.PredictiveHigh444=6]="PredictiveHigh444"})(Y||(ne.Profile=Y={}));var O;(function(i){i[i.L1_b=0]="L1_b",i[i.L1=10]="L1",i[i.L1_1=11]="L1_1",i[i.L1_2=12]="L1_2",i[i.L1_3=13]="L1_3",i[i.L2=20]="L2",i[i.L2_1=21]="L2_1",i[i.L2_2=22]="L2_2",i[i.L3=30]="L3",i[i.L3_1=31]="L3_1",i[i.L3_2=32]="L3_2",i[i.L4=40]="L4",i[i.L4_1=41]="L4_1",i[i.L4_2=42]="L4_2",i[i.L5=50]="L5",i[i.L5_1=51]="L5_1",i[i.L5_2=52]="L5_2"})(O||(ne.Level=O={}));class nr{constructor(e,t){this.profile=e,this.level=t}}ne.ProfileLevelId=nr;const uo=new nr(Y.ConstrainedBaseline,O.L3_1);class Qe{constructor(e){this.mask=~Ui("x",e),this.masked_value=Ui("1",e)}isMatch(e){return this.masked_value===(e&this.mask)}}class We{constructor(e,t,s){this.profile_idc=e,this.profile_iop=t,this.profile=s}}const ho=[new We(66,new Qe("x1xx0000"),Y.ConstrainedBaseline),new We(77,new Qe("1xxx0000"),Y.ConstrainedBaseline),new We(88,new Qe("11xx0000"),Y.ConstrainedBaseline),new We(66,new Qe("x0xx0000"),Y.Baseline),new We(88,new Qe("10xx0000"),Y.Baseline),new We(77,new Qe("0x0x0000"),Y.Main),new We(100,new Qe("00000000"),Y.High),new We(100,new Qe("00001100"),Y.ConstrainedHigh),new We(244,new Qe("00000000"),Y.PredictiveHigh444)];function Qn(i){if(typeof i!="string"||i.length!==6)return;const t=parseInt(i,16);if(t===0)return;const s=t&255,r=t>>8&255,n=t>>16&255;let a;switch(s){case O.L1_1:{a=r&16?O.L1_b:O.L1_1;break}case O.L1:case O.L1_2:case O.L1_3:case O.L2:case O.L2_1:case O.L2_2:case O.L3:case O.L3_1:case O.L3_2:case O.L4:case O.L4_1:case O.L4_2:case O.L5:case O.L5_1:case O.L5_2:{a=s;break}default:{dt.warn(`parseProfileLevelId() | unrecognized level_idc [str:${i}, level_idc:${s}]`);return}}for(const o of ho)if(n===o.profile_idc&&o.profile_iop.isMatch(r))return new nr(o.profile,a);dt.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${i}, profile_idc:${n}, profile_iop:${r}]`)}ne.parseProfileLevelId=Qn;function Wn(i){if(i.level==O.L1_b)switch(i.profile){case Y.ConstrainedBaseline:return"42f00b";case Y.Baseline:return"42100b";case Y.Main:return"4d100b";default:{dt.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${i.profile}`);return}}let e;switch(i.profile){case Y.ConstrainedBaseline:{e="42e0";break}case Y.Baseline:{e="4200";break}case Y.Main:{e="4d00";break}case Y.ConstrainedHigh:{e="640c";break}case Y.High:{e="6400";break}case Y.PredictiveHigh444:{e="f400";break}default:{dt.warn(`profileLevelIdToString() | unrecognized profile ${i.profile}`);return}}let t=i.level.toString(16);return t.length===1&&(t=`0${t}`),`${e}${t}`}ne.profileLevelIdToString=Wn;function fo(i){switch(i){case Y.ConstrainedBaseline:return"ConstrainedBaseline";case Y.Baseline:return"Baseline";case Y.Main:return"Main";case Y.ConstrainedHigh:return"ConstrainedHigh";case Y.High:return"High";case Y.PredictiveHigh444:return"PredictiveHigh444";default:{dt.warn(`profileToString() | unrecognized profile ${i}`);return}}}ne.profileToString=fo;function mo(i){switch(i){case O.L1_b:return"1b";case O.L1:return"1";case O.L1_1:return"1.1";case O.L1_2:return"1.2";case O.L1_3:return"1.3";case O.L2:return"2";case O.L2_1:return"2.1";case O.L2_2:return"2.2";case O.L3:return"3";case O.L3_1:return"3.1";case O.L3_2:return"3.2";case O.L4:return"4";case O.L4_1:return"4.1";case O.L4_2:return"4.2";case O.L5:return"5";case O.L5_1:return"5.1";case O.L5_2:return"5.2";default:{dt.warn(`levelToString() | unrecognized level ${i}`);return}}}ne.levelToString=mo;function fs(i={}){const e=i["profile-level-id"];return e?Qn(e):uo}ne.parseSdpProfileLevelId=fs;function go(i={},e={}){const t=fs(i),s=fs(e);return!!(t&&s&&t.profile===s.profile)}ne.isSameProfile=go;function _o(i={},e={}){if(!i["profile-level-id"]&&!e["profile-level-id"]){dt.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const t=fs(i),s=fs(e);if(!t)throw new TypeError("invalid local_profile_level_id");if(!s)throw new TypeError("invalid remote_profile_level_id");if(t.profile!==s.profile)throw new TypeError("H264 Profile mismatch");const r=zi(i)&&zi(e),n=t.level,a=s.level,o=vo(n,a),d=r?n:o;return dt.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${t.profile}, level:${d}]`),Wn(new nr(t.profile,d))}ne.generateProfileLevelIdStringForAnswer=_o;function Ui(i,e){return+(e[0]===i)<<7|+(e[1]===i)<<6|+(e[2]===i)<<5|+(e[3]===i)<<4|+(e[4]===i)<<3|+(e[5]===i)<<2|+(e[6]===i)<<1|+(e[7]===i)<<0}function wo(i,e){return i===O.L1_b?e!==O.L1&&e!==O.L1_b:e===O.L1_b?i!==O.L1:i<e}function vo(i,e){return wo(i,e)?i:e}function zi(i={}){const e=i["level-asymmetry-allowed"];return e===!0||e===1||e==="1"}var bo=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),So=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Xn=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&bo(t,e,s[r]);return So(t,e),t}}();Object.defineProperty(J,"__esModule",{value:!0});J.validateRtpCapabilities=To;J.validateRtpParameters=ti;J.validateSctpStreamParameters=Po;J.validateSctpCapabilities=Eo;J.getExtendedRtpCapabilities=Lo;J.getRecvRtpCapabilities=Mo;J.getSendingRtpParameters=xo;J.getSendingRemoteRtpParameters=Io;J.reduceCodecs=Oo;J.generateProbatorRtpParameters=ko;J.canSend=jo;J.canReceive=$o;const Hi=Xn(ne),yo=Xn(ae),Ro="probator",Co=1234,Do=127;function To(i){if(typeof i!="object")throw new TypeError("caps is not an object");if(i.codecs&&!Array.isArray(i.codecs))throw new TypeError("caps.codecs is not an array");i.codecs||(i.codecs=[]);for(const e of i.codecs)No(e);if(i.headerExtensions&&!Array.isArray(i.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");i.headerExtensions||(i.headerExtensions=[]);for(const e of i.headerExtensions)Ao(e)}function ti(i){if(typeof i!="object")throw new TypeError("params is not an object");if(i.mid&&typeof i.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(i.codecs))throw new TypeError("missing params.codecs");for(const e of i.codecs)Fo(e);if(i.headerExtensions&&!Array.isArray(i.headerExtensions))throw new TypeError("params.headerExtensions is not an array");i.headerExtensions||(i.headerExtensions=[]);for(const e of i.headerExtensions)Bo(e);if(i.encodings&&!Array.isArray(i.encodings))throw new TypeError("params.encodings is not an array");i.encodings||(i.encodings=[]);for(const e of i.encodings)Uo(e);if(i.rtcp&&typeof i.rtcp!="object")throw new TypeError("params.rtcp is not an object");i.rtcp||(i.rtcp={}),zo(i.rtcp)}function Po(i){if(typeof i!="object")throw new TypeError("params is not an object");if(typeof i.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof i.ordered=="boolean"?e=!0:i.ordered=!0,i.maxPacketLifeTime&&typeof i.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(i.maxRetransmits&&typeof i.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(i.maxPacketLifeTime&&i.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&i.ordered&&(i.maxPacketLifeTime||i.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(i.maxPacketLifeTime||i.maxRetransmits)&&(i.ordered=!1),i.label&&typeof i.label!="string")throw new TypeError("invalid params.label");if(i.protocol&&typeof i.protocol!="string")throw new TypeError("invalid params.protocol")}function Eo(i){if(typeof i!="object")throw new TypeError("caps is not an object");if(!i.numStreams||typeof i.numStreams!="object")throw new TypeError("missing caps.numStreams");Ho(i.numStreams)}function Lo(i,e){const t={codecs:[],headerExtensions:[]};for(const s of e.codecs??[]){if(us(s))continue;const r=(i.codecs??[]).find(a=>Jn(a,s,{strict:!0,modify:!0}));if(!r)continue;const n={mimeType:r.mimeType,kind:r.kind,clockRate:r.clockRate,channels:r.channels,localPayloadType:r.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:s.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:r.parameters,remoteParameters:s.parameters,rtcpFeedback:Go(r,s)};t.codecs.push(n)}for(const s of t.codecs){const r=i.codecs.find(a=>us(a)&&a.parameters.apt===s.localPayloadType),n=e.codecs.find(a=>us(a)&&a.parameters.apt===s.remotePayloadType);r&&n&&(s.localRtxPayloadType=r.preferredPayloadType,s.remoteRtxPayloadType=n.preferredPayloadType)}for(const s of e.headerExtensions){const r=i.headerExtensions.find(a=>Ko(a,s));if(!r)continue;const n={kind:s.kind,uri:s.uri,sendId:r.preferredId,recvId:s.preferredId,encrypt:r.preferredEncrypt,direction:"sendrecv"};switch(s.direction){case"sendrecv":{n.direction="sendrecv";break}case"recvonly":{n.direction="sendonly";break}case"sendonly":{n.direction="recvonly";break}case"inactive":{n.direction="inactive";break}}t.headerExtensions.push(n)}return t}function Mo(i){const e={codecs:[],headerExtensions:[]};for(const t of i.codecs){const s={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(s),!t.remoteRtxPayloadType)continue;const r={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(r)}for(const t of i.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;const s={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(s)}return e}function xo(i,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const s of e.codecs){if(s.kind!==i)continue;const r={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.localParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(r),s.localRtxPayloadType){const n={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const s of e.headerExtensions){if(s.kind&&s.kind!==i||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;const r={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(r)}return t}function Io(i,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const s of e.codecs){if(s.kind!==i)continue;const r={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.remoteParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(r),s.localRtxPayloadType){const n={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const s of e.headerExtensions){if(s.kind&&s.kind!==i||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;const r={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(r)}if(t.headerExtensions.some(s=>s.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback??[]).filter(r=>r.type!=="goog-remb");else if(t.headerExtensions.some(s=>s.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback??[]).filter(r=>r.type!=="transport-cc");else for(const s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback??[]).filter(r=>r.type!=="transport-cc"&&r.type!=="goog-remb");return t}function Oo(i,e){const t=[];if(!e)t.push(i[0]),us(i[1])&&t.push(i[1]);else{for(let s=0;s<i.length;++s)if(Jn(i[s],e,{strict:!0})){t.push(i[s]),us(i[s+1])&&t.push(i[s+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}function ko(i){i=yo.clone(i),ti(i);const e={mid:Ro,codecs:[],headerExtensions:[],encodings:[{ssrc:Co}],rtcp:{cname:"probator"}};return e.codecs.push(i.codecs[0]),e.codecs[0].payloadType=Do,e.headerExtensions=i.headerExtensions,e}function jo(i,e){return e.codecs.some(t=>t.kind===i)}function $o(i,e){if(ti(i),i.codecs.length===0)return!1;const t=i.codecs[0];return e.codecs.some(s=>s.remotePayloadType===t.payloadType)}function No(i){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof i!="object")throw new TypeError("codec is not an object");if(!i.mimeType||typeof i.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(i.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(i.kind=t[1].toLowerCase(),i.preferredPayloadType&&typeof i.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof i.clockRate!="number")throw new TypeError("missing codec.clockRate");i.kind==="audio"?typeof i.channels!="number"&&(i.channels=1):delete i.channels,(!i.parameters||typeof i.parameters!="object")&&(i.parameters={});for(const s of Object.keys(i.parameters)){let r=i.parameters[s];if(r===void 0&&(i.parameters[s]="",r=""),typeof r!="string"&&typeof r!="number")throw new TypeError(`invalid codec parameter [key:${s}s, value:${r}]`);if(s==="apt"&&typeof r!="number")throw new TypeError("invalid codec apt parameter")}(!i.rtcpFeedback||!Array.isArray(i.rtcpFeedback))&&(i.rtcpFeedback=[]);for(const s of i.rtcpFeedback)Yn(s)}function Yn(i){if(typeof i!="object")throw new TypeError("fb is not an object");if(!i.type||typeof i.type!="string")throw new TypeError("missing fb.type");(!i.parameter||typeof i.parameter!="string")&&(i.parameter="")}function Ao(i){if(typeof i!="object")throw new TypeError("ext is not an object");if(i.kind!=="audio"&&i.kind!=="video")throw new TypeError("invalid ext.kind");if(!i.uri||typeof i.uri!="string")throw new TypeError("missing ext.uri");if(typeof i.preferredId!="number")throw new TypeError("missing ext.preferredId");if(i.preferredEncrypt&&typeof i.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(i.preferredEncrypt||(i.preferredEncrypt=!1),i.direction&&typeof i.direction!="string")throw new TypeError("invalid ext.direction");i.direction||(i.direction="sendrecv")}function Fo(i){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof i!="object")throw new TypeError("codec is not an object");if(!i.mimeType||typeof i.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(i.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof i.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof i.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof i.channels!="number"&&(i.channels=1):delete i.channels,(!i.parameters||typeof i.parameters!="object")&&(i.parameters={});for(const r of Object.keys(i.parameters)){let n=i.parameters[r];if(n===void 0&&(i.parameters[r]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${r}s, value:${n}]`);if(r==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!i.rtcpFeedback||!Array.isArray(i.rtcpFeedback))&&(i.rtcpFeedback=[]);for(const r of i.rtcpFeedback)Yn(r)}function Bo(i){if(typeof i!="object")throw new TypeError("ext is not an object");if(!i.uri||typeof i.uri!="string")throw new TypeError("missing ext.uri");if(typeof i.id!="number")throw new TypeError("missing ext.id");if(i.encrypt&&typeof i.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");i.encrypt||(i.encrypt=!1),(!i.parameters||typeof i.parameters!="object")&&(i.parameters={});for(const e of Object.keys(i.parameters)){let t=i.parameters[e];if(t===void 0&&(i.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}function Uo(i){if(typeof i!="object")throw new TypeError("encoding is not an object");if(i.ssrc&&typeof i.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(i.rid&&typeof i.rid!="string")throw new TypeError("invalid encoding.rid");if(i.rtx&&typeof i.rtx!="object")throw new TypeError("invalid encoding.rtx");if(i.rtx&&typeof i.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!i.dtx||typeof i.dtx!="boolean")&&(i.dtx=!1),i.scalabilityMode&&typeof i.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function zo(i){if(typeof i!="object")throw new TypeError("rtcp is not an object");if(i.cname&&typeof i.cname!="string")throw new TypeError("invalid rtcp.cname");(!i.reducedSize||typeof i.reducedSize!="boolean")&&(i.reducedSize=!0)}function Ho(i){if(typeof i!="object")throw new TypeError("numStreams is not an object");if(typeof i.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof i.MIS!="number")throw new TypeError("missing numStreams.MIS")}function us(i){return i?/.+\/rtx$/i.test(i.mimeType):!1}function Jn(i,e,{strict:t=!1,modify:s=!1}={}){const r=i.mimeType.toLowerCase(),n=e.mimeType.toLowerCase();if(r!==n||i.clockRate!==e.clockRate||i.channels!==e.channels)return!1;switch(r){case"video/h264":{if(t){const a=i.parameters["packetization-mode"]||0,o=e.parameters["packetization-mode"]||0;if(a!==o||!Hi.isSameProfile(i.parameters,e.parameters))return!1;let d;try{d=Hi.generateProfileLevelIdStringForAnswer(i.parameters,e.parameters)}catch{return!1}s&&(d?(i.parameters["profile-level-id"]=d,e.parameters["profile-level-id"]=d):(delete i.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){const a=i.parameters["profile-id"]||0,o=e.parameters["profile-id"]||0;if(a!==o)return!1}break}}return!0}function Ko(i,e){return!(i.kind&&e.kind&&i.kind!==e.kind||i.uri!==e.uri)}function Go(i,e){const t=[];for(const s of i.rtcpFeedback??[]){const r=(e.rtcpFeedback??[]).find(n=>n.type===s.type&&(n.parameter===s.parameter||!n.parameter&&!s.parameter));r&&t.push(r)}return t}var ms={},ot={},ar={};Object.defineProperty(ar,"__esModule",{value:!0});ar.Logger=void 0;const Ct=sr,Dt="awaitqueue";class Vo{constructor(e){e?(this._debug=(0,Ct.default)(`${Dt}:${e}`),this._warn=(0,Ct.default)(`${Dt}:WARN:${e}`),this._error=(0,Ct.default)(`${Dt}:ERROR:${e}`)):(this._debug=(0,Ct.default)(Dt),this._warn=(0,Ct.default)(`${Dt}:WARN`),this._error=(0,Ct.default)(`${Dt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}ar.Logger=Vo;Object.defineProperty(ot,"__esModule",{value:!0});ot.AwaitQueue=ot.AwaitQueueRemovedTaskError=ot.AwaitQueueStoppedError=void 0;const qo=ar,st=new qo.Logger;class or extends Error{constructor(e){super(e??"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,or)}}ot.AwaitQueueStoppedError=or;class cr extends Error{constructor(e){super(e??"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,cr)}}ot.AwaitQueueRemovedTaskError=cr;class Qo{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(e,t){if(t=t??e.name,st.debug(`push() [name:${t}]`),typeof e!="function")throw new TypeError("given task is not a function");if(t)try{Object.defineProperty(e,"name",{value:t})}catch{}return new Promise((s,r)=>{const n={id:this.nextTaskId++,task:e,name:t,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(n.completed)return;n.completed=!0,this.pendingTasks.delete(n.id),st.debug(`resolving task [name:${n.name}]`),s(a);const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)},reject:a=>{if(!n.completed&&(n.completed=!0,this.pendingTasks.delete(n.id),st.debug(`rejecting task [name:${n.name}]: %s`,String(a)),r(a),!this.stopping)){const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)}}};this.pendingTasks.set(n.id,n),this.pendingTasks.size===1&&this.execute(n)})}stop(){st.debug("stop()"),this.stopping=!0;for(const e of this.pendingTasks.values())st.debug(`stop() | stopping task [name:${e.name}]`),e.reject(new or);this.stopping=!1}remove(e){st.debug(`remove() [taskIdx:${e}]`);const t=Array.from(this.pendingTasks.values())[e];if(!t){st.debug(`stop() | no task with given idx [taskIdx:${e}]`);return}t.reject(new cr)}dump(){const e=Date.now();let t=0;return Array.from(this.pendingTasks.values()).map(s=>({idx:t++,task:s.task,name:s.name,enqueuedTime:s.executedAt?s.executedAt-s.enqueuedAt:e-s.enqueuedAt,executionTime:s.executedAt?e-s.executedAt:0}))}async execute(e){if(st.debug(`execute() [name:${e.name}]`),e.executedAt)throw new Error("task already being executed");e.executedAt=Date.now();try{const t=await e.task();e.resolve(t)}catch(t){e.reject(t)}}}ot.AwaitQueue=Qo;/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let Ki;var Wo=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:_):i=>(Ki||(Ki=Promise.resolve())).then(i).catch(e=>setTimeout(()=>{throw e},0)),gs={};Object.defineProperty(gs,"__esModule",{value:!0});gs.Producer=void 0;const Xo=te,Gi=Ue,Tt=de,Me=new Xo.Logger("Producer");class Yo extends Gi.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:s,track:r,rtpParameters:n,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:d,appData:p}){super(),this._closed=!1,this._observer=new Gi.EnhancedEventEmitter,Me.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=s,this._track=r,this._kind=r.kind,this._rtpParameters=n,this._paused=o?!r.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=o,this._zeroRtpOnPause=d,this._appData=p??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Me.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Me.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Tt.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(Me.debug("pause()"),this._closed){Me.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(Me.debug("resume()"),this._closed){Me.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(Me.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new Tt.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new Tt.InvalidStateError("track ended");if(e===this._track){Me.debug("replaceTrack() | same track, ignored");return}await new Promise((t,s)=>{this.safeEmit("@replacetrack",e,t,s)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new Tt.InvalidStateError("closed");if(this._kind!=="video")throw new Tt.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,s)=>{this.safeEmit("@setmaxspatiallayer",e,t,s)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new Tt.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,s)=>{this.safeEmit("@setrtpencodingparameters",e,t,s)})}onTrackEnded(){Me.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}}gs.Producer=Yo;var _s={};Object.defineProperty(_s,"__esModule",{value:!0});_s.Consumer=void 0;const Jo=te,Vi=Ue,Zo=de,xe=new Jo.Logger("Consumer");class ec extends Vi.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:s,rtpReceiver:r,track:n,rtpParameters:a,appData:o}){super(),this._closed=!1,this._observer=new Vi.EnhancedEventEmitter,xe.debug("constructor()"),this._id=e,this._localId=t,this._producerId=s,this._rtpReceiver=r,this._track=n,this._rtpParameters=a,this._paused=!n.enabled,this._appData=o??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(xe.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(xe.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Zo.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(xe.debug("pause()"),this._closed){xe.error("pause() | Consumer closed");return}if(this._paused){xe.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(xe.debug("resume()"),this._closed){xe.error("resume() | Consumer closed");return}if(!this._paused){xe.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){xe.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}}_s.Consumer=ec;var ws={};Object.defineProperty(ws,"__esModule",{value:!0});ws.DataProducer=void 0;const tc=te,qi=Ue,sc=de,Xe=new tc.Logger("DataProducer");class rc extends qi.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:s,appData:r}){super(),this._closed=!1,this._observer=new qi.EnhancedEventEmitter,Xe.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=s,this._appData=r??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Xe.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Xe.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(Xe.debug("send()"),this._closed)throw new sc.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Xe.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?Xe.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Xe.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Xe.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||Xe.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}ws.DataProducer=rc;var vs={};Object.defineProperty(vs,"__esModule",{value:!0});vs.DataConsumer=void 0;const ic=te,Qi=Ue,ut=new ic.Logger("DataConsumer");class nc extends Qi.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:s,sctpStreamParameters:r,appData:n}){super(),this._closed=!1,this._observer=new Qi.EnhancedEventEmitter,ut.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=s,this._sctpStreamParameters=r,this._appData=n??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(ut.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(ut.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(ut.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?ut.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):ut.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(ut.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}vs.DataConsumer=nc;var ac=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),oc=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Zn=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&ac(t,e,s[r]);return oc(t,e),t}}(),cc=_&&_.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ms,"__esModule",{value:!0});ms.Transport=void 0;const dc=ot,kr=cc(Wo),pc=te,Wi=Ue,pe=de,jr=Zn(ae),is=Zn(J),lc=gs,uc=_s,hc=ws,fc=vs,oe=new pc.Logger("Transport");class mc{constructor(e){this.consumerOptions=e,this.promise=new Promise((t,s)=>{this.resolve=t,this.reject=s})}}class gc extends Wi.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:s,iceCandidates:r,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:c,appData:u,handlerFactory:l,extendedRtpCapabilities:h,canProduceByKind:f}){super(),this._closed=!1,this._iceGatheringState="new",this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new dc.AwaitQueue,this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new Wi.EnhancedEventEmitter,oe.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=h,this._canProduceByKind=f,this._maxSctpMessageSize=a?a.maxMessageSize:null;const g=jr.clone(p)??{};delete g.iceServers,delete g.iceTransportPolicy,delete g.bundlePolicy,delete g.rtcpMuxPolicy,delete g.sdpSemantics,this._handler=l(),this._handler.run({direction:e,iceParameters:s,iceCandidates:r,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:g,proprietaryConstraints:c,extendedRtpCapabilities:h}),this._appData=u??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){if(!this._closed){oe.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new pe.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(oe.debug("restartIce()"),this._closed)throw new pe.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(oe.debug("updateIceServers()"),this._closed)throw new pe.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:s,codec:r,stopTracks:n=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:o=!1,onRtpSender:d,appData:p={}}={}){if(oe.debug("produce() [track:%o]",e),this._closed)throw new pe.InvalidStateError("closed");if(e){if(this._direction!=="send")throw new pe.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new pe.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(p&&typeof p!="object")throw new TypeError("if given, appData must be an object")}else throw new pe.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let c;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?c=void 0:t&&(c=t.map(f=>{const g={active:!0};return f.active===!1&&(g.active=!1),typeof f.dtx=="boolean"&&(g.dtx=f.dtx),typeof f.scalabilityMode=="string"&&(g.scalabilityMode=f.scalabilityMode),typeof f.scaleResolutionDownBy=="number"&&(g.scaleResolutionDownBy=f.scaleResolutionDownBy),typeof f.maxBitrate=="number"&&(g.maxBitrate=f.maxBitrate),typeof f.maxFramerate=="number"&&(g.maxFramerate=f.maxFramerate),typeof f.adaptivePtime=="boolean"&&(g.adaptivePtime=f.adaptivePtime),typeof f.priority=="string"&&(g.priority=f.priority),typeof f.networkPriority=="string"&&(g.networkPriority=f.networkPriority),g}));const{localId:u,rtpParameters:l,rtpSender:h}=await this._handler.send({track:e,encodings:c,codecOptions:s,codec:r,onRtpSender:d});try{is.validateRtpParameters(l);const{id:f}=await new Promise((m,w)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:l,appData:p},m,w)}),g=new lc.Producer({id:f,localId:u,rtpSender:h,track:e,rtpParameters:l,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,appData:p});return this._producers.set(g.id,g),this.handleProducer(g),this._observer.safeEmit("newproducer",g),g}catch(f){throw this._handler.stopSending(u).catch(()=>{}),f}},"transport.produce()").catch(c=>{if(n)try{e.stop()}catch{}throw c})}async consume({id:e,producerId:t,kind:s,rtpParameters:r,streamId:n,onRtpReceiver:a,appData:o={}}){if(oe.debug("consume()"),this._closed)throw new pe.InvalidStateError("closed");if(this._direction!=="recv")throw new pe.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind '${s}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object");const d=jr.clone(r);if(!is.canReceive(d,this._extendedRtpCapabilities))throw new pe.UnsupportedError("cannot consume this Producer");const c=new mc({id:e,producerId:t,kind:s,rtpParameters:d,streamId:n,onRtpReceiver:a,appData:o});return this._pendingConsumerTasks.push(c),(0,kr.default)(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),c.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:s,label:r="",protocol:n="",appData:a={}}={}){if(oe.debug("produceData()"),this._closed)throw new pe.InvalidStateError("closed");if(this._direction!=="send")throw new pe.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new pe.UnsupportedError("SCTP not enabled by remote Transport");return(t||s)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:o,sctpStreamParameters:d}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n});is.validateSctpStreamParameters(d);const{id:p}=await new Promise((u,l)=>{this.safeEmit("producedata",{sctpStreamParameters:d,label:r,protocol:n,appData:a},u,l)}),c=new hc.DataProducer({id:p,dataChannel:o,sctpStreamParameters:d,appData:a});return this._dataProducers.set(c.id,c),this.handleDataProducer(c),this._observer.safeEmit("newdataproducer",c),c},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:s,label:r="",protocol:n="",appData:a={}}){if(oe.debug("consumeData()"),this._closed)throw new pe.InvalidStateError("closed");if(this._direction!=="recv")throw new pe.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new pe.UnsupportedError("SCTP not enabled by remote Transport");const o=jr.clone(s);return is.validateSctpStreamParameters(o),this._awaitQueue.push(async()=>{const{dataChannel:d}=await this._handler.receiveDataChannel({sctpStreamParameters:o,label:r,protocol:n}),p=new fc.DataConsumer({id:e,dataProducerId:t,dataChannel:d,sctpStreamParameters:o,appData:a});return this._dataConsumers.set(p.id,p),this.handleDataConsumer(p),this._observer.safeEmit("newdataconsumer",p),p},"transport.consumeData()")}async createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){oe.debug("createPendingConsumers() | there is no Consumer to be created");return}const e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t;const s=[];for(const r of e){const{id:n,kind:a,rtpParameters:o,streamId:d,onRtpReceiver:p}=r.consumerOptions;s.push({trackId:n,kind:a,rtpParameters:o,streamId:d,onRtpReceiver:p})}try{const r=await this._handler.receive(s);for(let n=0;n<r.length;++n){const a=e[n],o=r[n],{id:d,producerId:p,kind:c,rtpParameters:u,appData:l}=a.consumerOptions,{localId:h,rtpReceiver:f,track:g}=o,m=new uc.Consumer({id:d,localId:h,producerId:p,rtpReceiver:f,track:g,rtpParameters:u,appData:l});this._consumers.set(m.id,m),this.handleConsumer(m),!this._probatorConsumerCreated&&!t&&c==="video"&&(t=m),this._observer.safeEmit("newconsumer",m),a.resolve(m)}}catch(r){for(const n of e)n.reject(r)}if(t)try{const r=is.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:r}]),oe.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(r){oe.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",r)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){oe.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map(s=>s.localId);await this._handler.pauseReceiving(t)}catch(t){oe.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){oe.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map(s=>s.localId);await this._handler.resumeReceiving(t)}catch(t){oe.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){oe.debug("closePendingConsumers() | there is no Consumer to be closed");return}const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){oe.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:t},s,r)=>{if(this._closed){r(new pe.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},s,r)}),e.on("@icegatheringstatechange",t=>{t!==this._iceGatheringState&&(oe.debug("ICE gathering state changed to %s",t),this._iceGatheringState=t,this._closed||this.safeEmit("icegatheringstatechange",t))}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(oe.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(e.localId),"producer @close event").catch(t=>oe.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,s)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(s)}),e.on("@resume",(t,s)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(s)}),e.on("@replacetrack",(t,s,r)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(s).catch(r)}),e.on("@setmaxspatiallayer",(t,s,r)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(s).catch(r)}),e.on("@setrtpencodingparameters",(t,s,r)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(s).catch(r)}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new pe.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(s)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),(0,kr.default)(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),(0,kr.default)(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new pe.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(s)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}}ms.Transport=gc;var dr={},se={},ea={},ta={exports:{}},Xi=ta.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(i){return i.encoding?"rtpmap:%d %s/%s/%s":i.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(i){return i.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(i){return i.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(i){return"extmap:%d"+(i.direction?"/%s":"%v")+(i["encrypt-uri"]?" %s":"%v")+" %s"+(i.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(i){return i.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(i){var e="candidate:%s %d %s %d %s %d typ %s";return e+=i.raddr!=null?" raddr %s rport %d":"%v%v",e+=i.tcptype!=null?" tcptype %s":"%v",i.generation!=null&&(e+=" generation %d"),e+=i["network-id"]!=null?" network-id %d":"%v",e+=i["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(i){var e="ssrc:%d";return i.attribute!=null&&(e+=" %s",i.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(i){return i.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(i){return i.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(i){return"imageattr:%s %s %s"+(i.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(i){return"simulcast:%s %s"+(i.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(i){return"ts-refclk:%s"+(i.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(i){var e="mediaclk:";return e+=i.id!=null?"id=%s %s":"%v%s",e+=i.mediaClockValue!=null?"=%s":"",e+=i.rateNumerator!=null?" rate=%s":"",e+=i.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Xi).forEach(function(i){var e=Xi[i];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var si=ta.exports;(function(i){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,d,p,c){if(c&&!p)d[c]=e(o[1]);else for(var u=0;u<p.length;u+=1)o[u+1]!=null&&(d[p[u]]=e(o[u+1]))},s=function(o,d,p){var c=o.name&&o.names;o.push&&!d[o.push]?d[o.push]=[]:c&&!d[o.name]&&(d[o.name]={});var u=o.push?{}:c?d[o.name]:d;t(p.match(o.reg),u,o.names,o.name),o.push&&d[o.push].push(u)},r=si,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(o){var d={},p=[],c=d;return o.split(/(\r\n|\r|\n)/).filter(n).forEach(function(u){var l=u[0],h=u.slice(2);l==="m"&&(p.push({rtp:[],fmtp:[]}),c=p[p.length-1]);for(var f=0;f<(r[l]||[]).length;f+=1){var g=r[l][f];if(g.reg.test(h))return s(g,c,h)}}),d.media=p,d};var a=function(o,d){var p=d.split(/=(.+)/,2);return p.length===2?o[p[0]]=e(p[1]):p.length===1&&d.length>1&&(o[p[0]]=void 0),o};i.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(o){return o.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(o){for(var d=[],p=o.split(" ").map(e),c=0;c<p.length;c+=3)d.push({component:p[c],ip:p[c+1],port:p[c+2]});return d},i.parseImageAttributes=function(o){return o.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(a,{})})},i.parseSimulcastStreamList=function(o){return o.split(";").map(function(d){return d.split(",").map(function(p){var c,u=!1;return p[0]!=="~"?c=e(p):(c=e(p.substring(1,p.length)),u=!0),{scid:c,paused:u}})})}})(ea);var $r=si,_c=/%[sdv%]/g,wc=function(i){var e=1,t=arguments,s=t.length;return i.replace(_c,function(r){if(e>=s)return r;var n=t[e];switch(e+=1,r){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},ns=function(i,e,t){var s=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,r=[i+"="+s];if(e.names)for(var n=0;n<e.names.length;n+=1){var a=e.names[n];e.name?r.push(t[e.name][a]):r.push(t[e.names[n]])}else r.push(t[e.name]);return wc.apply(null,r)},vc=["v","o","s","i","u","e","p","c","b","t","r","z","a"],bc=["i","c","b","a"],Sc=function(i,e){e=e||{},i.version==null&&(i.version=0),i.name==null&&(i.name=" "),i.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var t=e.outerOrder||vc,s=e.innerOrder||bc,r=[];return t.forEach(function(n){$r[n].forEach(function(a){a.name in i&&i[a.name]!=null?r.push(ns(n,a,i)):a.push in i&&i[a.push]!=null&&i[a.push].forEach(function(o){r.push(ns(n,a,o))})})}),i.media.forEach(function(n){r.push(ns("m",$r.m[0],n)),s.forEach(function(a){$r[a].forEach(function(o){o.name in n&&n[o.name]!=null?r.push(ns(a,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(d){r.push(ns(a,o,d))})})})}),r.join(`\r
`)+`\r
`},ht=ea,yc=Sc,Rc=si;se.grammar=Rc;se.write=yc;se.parse=ht.parse;se.parseParams=ht.parseParams;se.parseFmtpConfig=ht.parseFmtpConfig;se.parsePayloads=ht.parsePayloads;se.parseRemoteCandidates=ht.parseRemoteCandidates;se.parseImageAttributes=ht.parseImageAttributes;se.parseSimulcastStreamList=ht.parseSimulcastStreamList;var fe={},Cc=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Dc=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Tc=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Cc(t,e,s[r]);return Dc(t,e),t}}();Object.defineProperty(fe,"__esModule",{value:!0});fe.extractRtpCapabilities=Pc;fe.extractDtlsParameters=Ec;fe.getCname=Lc;fe.applyCodecParameters=Mc;const sa=Tc(se);function Pc({sdpObject:i}){const e=new Map,t=[];let s=!1,r=!1;for(const a of i.media){const o=a.type;switch(o){case"audio":{if(s)continue;s=!0;break}case"video":{if(r)continue;r=!0;break}default:continue}for(const d of a.rtp){const p={kind:o,mimeType:`${o}/${d.codec}`,preferredPayloadType:d.payload,clockRate:d.rate,channels:d.encoding,parameters:{},rtcpFeedback:[]};e.set(p.preferredPayloadType,p)}for(const d of a.fmtp||[]){const p=sa.parseParams(d.config),c=e.get(d.payload);c&&(p!=null&&p.hasOwnProperty("profile-level-id")&&(p["profile-level-id"]=String(p["profile-level-id"])),c.parameters=p)}for(const d of a.rtcpFb||[]){const p={type:d.type,parameter:d.subtype};if(p.parameter||delete p.parameter,d.payload!=="*"){const c=e.get(d.payload);if(!c)continue;c.rtcpFeedback.push(p)}else for(const c of e.values())c.kind===o&&!/.+\/rtx$/i.test(c.mimeType)&&c.rtcpFeedback.push(p)}for(const d of a.ext||[]){if(d["encrypt-uri"])continue;const p={kind:o,uri:d.uri,preferredId:d.value};t.push(p)}}return{codecs:Array.from(e.values()),headerExtensions:t}}function Ec({sdpObject:i}){let e=i.setup,t=i.fingerprint;if(!e||!t){const n=(i.media||[]).find(a=>a.port!==0);n&&(e??(e=n.setup),t??(t=n.fingerprint))}if(e){if(!t)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let s;switch(e){case"active":{s="client";break}case"passive":{s="server";break}case"actpass":{s="auto";break}}return{role:s,fingerprints:[{algorithm:t.type,value:t.hash}]}}function Lc({offerMediaObject:i}){const e=(i.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}function Mc({offerRtpParameters:i,answerMediaObject:e}){for(const t of i.codecs){const s=t.mimeType.toLowerCase();if(s!=="audio/opus"||!(e.rtp||[]).find(o=>o.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let n=e.fmtp.find(o=>o.payload===t.payloadType);n||(n={payload:t.payloadType,config:""},e.fmtp.push(n));const a=sa.parseParams(n.config);switch(s){case"audio/opus":{const o=t.parameters["sprop-stereo"];o!==void 0&&(a.stereo=Number(o)?1:0);break}}n.config="";for(const o of Object.keys(a))n.config&&(n.config+=";"),n.config+=`${o}=${a[o]}`}}var ze={};Object.defineProperty(ze,"__esModule",{value:!0});ze.getRtpEncodings=xc;ze.addLegacySimulcast=Ic;function xc({offerMediaObject:i}){const e=new Set;for(const r of i.ssrcs||[]){const n=r.id;e.add(n)}if(e.size===0)throw new Error("no a=ssrc lines found");const t=new Map;for(const r of i.ssrcGroups||[]){if(r.semantics!=="FID")continue;let[n,a]=r.ssrcs.split(/\s+/);n=Number(n),a=Number(a),e.has(n)&&(e.delete(n),e.delete(a),t.set(n,a))}for(const r of e)t.set(r,null);const s=[];for(const[r,n]of t){const a={ssrc:r};n&&(a.rtx={ssrc:n}),s.push(a)}return s}function Ic({offerMediaObject:i,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");const t=(i.ssrcs||[]).find(u=>u.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");const[s,r]=t.value.split(" "),n=Number(t.id);let a;(i.ssrcGroups||[]).some(u=>{if(u.semantics!=="FID")return!1;const l=u.ssrcs.split(/\s+/);return Number(l[0])===n?(a=Number(l[1]),!0):!1});const o=i.ssrcs.find(u=>u.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");const d=o.value,p=[],c=[];for(let u=0;u<e;++u)p.push(n+u),a&&c.push(a+u);i.ssrcGroups=[],i.ssrcs=[],i.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(const u of p)i.ssrcs.push({id:u,attribute:"cname",value:d}),i.ssrcs.push({id:u,attribute:"msid",value:`${s} ${r}`});for(let u=0;u<c.length;++u){const l=p[u],h=c[u];i.ssrcs.push({id:h,attribute:"cname",value:d}),i.ssrcs.push({id:h,attribute:"msid",value:`${s} ${r}`}),i.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${h}`})}}var zt={};Object.defineProperty(zt,"__esModule",{value:!0});zt.addNackSuppportForOpus=Oc;function Oc(i){var e;for(const t of i.codecs??[])(t.mimeType.toLowerCase()==="audio/opus"||t.mimeType.toLowerCase()==="audio/multiopus")&&!((e=t.rtcpFeedback)!=null&&e.some(s=>s.type==="nack"&&!s.parameter))&&(t.rtcpFeedback||(t.rtcpFeedback=[]),t.rtcpFeedback.push({type:"nack"}))}var me={};Object.defineProperty(me,"__esModule",{value:!0});me.HandlerInterface=void 0;const kc=Ue;class jc extends kc.EnhancedEventEmitter{constructor(){super()}}me.HandlerInterface=jc;var we={},ct={},$c=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Nc=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),ra=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&$c(t,e,s[r]);return Nc(t,e),t}}();Object.defineProperty(ct,"__esModule",{value:!0});ct.OfferMediaSection=ct.AnswerMediaSection=ct.MediaSection=void 0;const Ac=ra(se),Yi=ra(ae);class ri{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:r=!1}){if(this._mediaObject={},this._planB=r,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const n of t){const a={};a.component=1,a.foundation=n.foundation,a.ip=n.address??n.ip,a.port=n.port,a.priority=n.priority,a.transport=n.protocol,a.type=n.type,n.tcpType&&(a.tcptype=n.tcpType),this._mediaObject.candidates.push(a)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}s&&this.setDtlsRole(s.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}}ct.MediaSection=ri;class Fc extends ri{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:r,plainRtpParameters:n,planB:a=!1,offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:c,extmapAllowMixed:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const l of p.codecs){const h={payload:l.payloadType,codec:Qr(l),rate:l.clockRate};l.channels>1&&(h.encoding=l.channels),this._mediaObject.rtp.push(h);const f=Yi.clone(l.parameters)??{};let g=Yi.clone(l.rtcpFeedback)??[];if(c){const{opusStereo:w,opusFec:N,opusDtx:b,opusMaxPlaybackRate:E,opusMaxAverageBitrate:K,opusPtime:ee,opusNack:ve,videoGoogleStartBitrate:Te,videoGoogleMaxBitrate:A,videoGoogleMinBitrate:C}=c,W=d.codecs.find(he=>he.payloadType===l.payloadType);switch(l.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{w!==void 0&&(W.parameters["sprop-stereo"]=w?1:0,f.stereo=w?1:0),N!==void 0&&(W.parameters.useinbandfec=N?1:0,f.useinbandfec=N?1:0),b!==void 0&&(W.parameters.usedtx=b?1:0,f.usedtx=b?1:0),E!==void 0&&(f.maxplaybackrate=E),K!==void 0&&(f.maxaveragebitrate=K),ee!==void 0&&(W.parameters.ptime=ee,f.ptime=ee),ve||(W.rtcpFeedback=W.rtcpFeedback.filter(he=>he.type!=="nack"||he.parameter),g=g.filter(he=>he.type!=="nack"||he.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{Te!==void 0&&(f["x-google-start-bitrate"]=Te),A!==void 0&&(f["x-google-max-bitrate"]=A),C!==void 0&&(f["x-google-min-bitrate"]=C);break}}}const m={payload:l.payloadType,config:""};for(const w of Object.keys(f))m.config&&(m.config+=";"),m.config+=`${w}=${f[w]}`;m.config&&this._mediaObject.fmtp.push(m);for(const w of g)this._mediaObject.rtcpFb.push({payload:l.payloadType,type:w.type,subtype:w.parameter})}this._mediaObject.payloads=p.codecs.map(l=>l.payloadType).join(" "),this._mediaObject.ext=[];for(const l of p.headerExtensions)(o.ext??[]).some(f=>f.uri===l.uri)&&this._mediaObject.ext.push({uri:l.uri,value:l.id});if(u&&o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(const l of o.rids??[])l.direction==="send"&&this._mediaObject.rids.push({id:l.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const l of o.rids??[])l.direction==="send"&&this._mediaObject.rids.push({id:l.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(e){var n,a;if(!((n=this._mediaObject.simulcast)!=null&&n.list1))return;const t={};for(const o of e)o.rid&&(t[o.rid]=o);const s=this._mediaObject.simulcast.list1,r=Ac.parseSimulcastStreamList(s);for(const o of r)for(const d of o)d.paused=!((a=t[d.scid])!=null&&a.active);this._mediaObject.simulcast.list1=r.map(o=>o.map(d=>`${d.paused?"~":""}${d.scid}`).join(",")).join(";")}}ct.AnswerMediaSection=Fc;class Bc extends ri{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:r,plainRtpParameters:n,planB:a=!1,mid:o,kind:d,offerRtpParameters:p,streamId:c,trackId:u,oldDataChannelSpec:l=!1}){var h;switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=d,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},r?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),d){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${c??"-"} ${u}`);for(const w of p.codecs){const N={payload:w.payloadType,codec:Qr(w),rate:w.clockRate};w.channels>1&&(N.encoding=w.channels),this._mediaObject.rtp.push(N);const b={payload:w.payloadType,config:""};for(const E of Object.keys(w.parameters))b.config&&(b.config+=";"),b.config+=`${E}=${w.parameters[E]}`;b.config&&this._mediaObject.fmtp.push(b);for(const E of w.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:w.payloadType,type:E.type,subtype:E.parameter})}this._mediaObject.payloads=p.codecs.map(w=>w.payloadType).join(" "),this._mediaObject.ext=[];for(const w of p.headerExtensions)this._mediaObject.ext.push({uri:w.uri,value:w.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const f=p.encodings[0],g=f.ssrc,m=(h=f.rtx)==null?void 0:h.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],p.rtcp.cname&&this._mediaObject.ssrcs.push({id:g,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:g,attribute:"msid",value:`${c??"-"} ${u}`}),m&&(p.rtcp.cname&&this._mediaObject.ssrcs.push({id:m,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:m,attribute:"msid",value:`${c??"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${g} ${m}`}));break}case"application":{l?(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:s}){var d;const r=e.encodings[0],n=r.ssrc,a=(d=r.rtx)==null?void 0:d.ssrc,o=this._mediaObject.payloads.split(" ");for(const p of e.codecs){if(o.includes(String(p.payloadType)))continue;const c={payload:p.payloadType,codec:Qr(p),rate:p.clockRate};p.channels>1&&(c.encoding=p.channels),this._mediaObject.rtp.push(c);const u={payload:p.payloadType,config:""};for(const l of Object.keys(p.parameters))u.config&&(u.config+=";"),u.config+=`${l}=${p.parameters[l]}`;u.config&&this._mediaObject.fmtp.push(u);for(const l of p.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:p.payloadType,type:l.type,subtype:l.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter(p=>!this._mediaObject.payloads.includes(p.payloadType)).map(p=>p.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t??"-"} ${s}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t??"-"} ${s}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${n} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){var n;const t=e.encodings[0],s=t.ssrc,r=(n=t.rtx)==null?void 0:n.ssrc;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(a=>a.id!==s&&a.id!==r),r&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(a=>a.ssrcs!==`${s} ${r}`))}}ct.OfferMediaSection=Bc;function Qr(i){const t=new RegExp("^(audio|video)/(.+)","i").exec(i.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}var Uc=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),zc=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Hc=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Uc(t,e,s[r]);return zc(t,e),t}}();Object.defineProperty(we,"__esModule",{value:!0});we.RemoteSdp=void 0;const Kc=Hc(se),Gc=te,Ns=ct,Nr=new Gc.Logger("RemoteSdp");class Vc{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:r,plainRtpParameters:n,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=s,this._sctpParameters=r,this._plainRtpParameters=n,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e!=null&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),s){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:s.fingerprints[o-1].algorithm,hash:s.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(e){Nr.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){Nr.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:s,answerRtpParameters:r,codecOptions:n,extmapAllowMixed:a=!1}){const o=new Ns.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:s,answerRtpParameters:r,codecOptions:n,extmapAllowMixed:a});t?this._replaceMediaSection(o,t):this._midToIndex.has(o.mid)?this._replaceMediaSection(o):this._addMediaSection(o)}receive({mid:e,kind:t,offerRtpParameters:s,streamId:r,trackId:n}){const a=this._midToIndex.get(e);let o;if(a!==void 0&&(o=this._mediaSections[a]),o)o.planBReceive({offerRtpParameters:s,streamId:r,trackId:n}),this._replaceMediaSection(o);else{o=new Ns.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:s,streamId:r,trackId:n});const d=this._mediaSections.find(p=>p.closed);d?this._replaceMediaSection(o,d.mid):this._addMediaSection(o)}}pauseMediaSection(e){this._findMediaSection(e).pause()}resumeSendingMediaSection(e){this._findMediaSection(e).resume()}resumeReceivingMediaSection(e){this._findMediaSection(e).resume()}disableMediaSection(e){this._findMediaSection(e).disable()}closeMediaSection(e){const t=this._findMediaSection(e);return e===this._firstMid?(Nr.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e),!1):(t.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(e,t){const s=this._findMediaSection(e);s.muxSimulcastStreams(t),this._replaceMediaSection(s)}planBStopReceiving({mid:e,offerRtpParameters:t}){const s=this._findMediaSection(e);s.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(s)}sendSctpAssociation({offerMediaObject:e}){const t=new Ns.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new Ns.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,Kc.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){const s=this._midToIndex.get(t);if(s===void 0)throw new Error(`no media section found for reuseMid '${t}'`);const r=this._mediaSections[s];this._mediaSections[s]=e,this._midToIndex.delete(r.mid),this._midToIndex.set(e.mid,s),this._sdpObject.media[s]=e.getObject(),this._regenerateBundleMids()}else{const s=this._midToIndex.get(e.mid);if(s===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[s]=e,this._sdpObject.media[s]=e.getObject()}}_findMediaSection(e){const t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}}we.RemoteSdp=Vc;var He={};Object.defineProperty(He,"__esModule",{value:!0});He.parse=Qc;const qc=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Qc(i){const e=qc.exec(i??"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}var Wc=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Xc=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Ht=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Wc(t,e,s[r]);return Xc(t,e),t}}();Object.defineProperty(dr,"__esModule",{value:!0});dr.Chrome111=void 0;const rt=Ht(se),Yc=te,Ji=Ht(ae),Pt=Ht(J),As=Ht(fe),Zi=Ht(ze),Jc=Ht(zt),Zc=de,ed=me,td=we,sd=He,L=new Yc.Logger("Chrome111"),rd="Chrome111",en={OS:1024,MIS:1024};class ii extends ed.HandlerInterface{static createFactory(){return()=>new ii}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return rd}close(){if(L.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){L.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const s=rt.parse(t.sdp),r=As.extractRtpCapabilities({sdpObject:s});return Jc.addNackSuppportForOpus(r),r}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return L.debug("getNativeSctpCapabilities()"),{numStreams:en}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),L.debug("run()"),this._direction=e,this._remoteSdp=new td.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Pt.getSendingRtpParameters("audio",c),video:Pt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Pt.getSendingRemoteRtpParameters("audio",c),video:Pt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(L.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),L.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),L.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});L.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};L.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();L.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r,onRtpSender:n}){if(this.assertNotClosed(),this.assertSendDirection(),L.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){let g=1;for(const m of t){const w=m.scalabilityMode?(0,sd.parse)(m.scalabilityMode).temporalLayers:3;w>g&&(g=w)}t.forEach((m,w)=>{m.rid=`r${w}`,m.scalabilityMode=`L1T${g}`})}const a=Ji.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=Pt.reduceCodecs(a.codecs,r);const o=Ji.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=Pt.reduceCodecs(o.codecs,r);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});n&&n(p.sender);const c=await this._pc.createOffer();let u=rt.parse(c.sdp);this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u}),L.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const l=p.mid;a.mid=l,u=rt.parse(this._pc.localDescription.sdp);const h=u.media[d.idx];if(a.rtcp.cname=As.getCname({offerMediaObject:h}),!t)a.encodings=Zi.getRtpEncodings({offerMediaObject:h});else if(t.length===1){const g=Zi.getRtpEncodings({offerMediaObject:h});Object.assign(g[0],t[0]),a.encodings=g}else a.encodings=t;this._remoteSdp.send({offerMediaObject:h,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s,extmapAllowMixed:!0});const f={type:"answer",sdp:this._remoteSdp.getSdp()};return L.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(l,p),{localId:l,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),L.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const r=await this._pc.createOffer();L.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const n={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),L.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();L.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),L.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();L.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?L.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):L.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),L.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();L.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),L.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();L.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};L.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%en.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=rt.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),L.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};L.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;L.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};L.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=s.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=rt.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);As.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:rt.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),L.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(c)this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const r of e){L.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};L.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();L.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){L.debug("pauseReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};L.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();L.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){L.debug("resumeReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};L.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();L.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};L.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};L.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=rt.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}L.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=rt.parse(this._pc.localDescription.sdp));const s=As.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Zc.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}dr.Chrome111=ii;var pr={},id=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),nd=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Kt=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&id(t,e,s[r]);return nd(t,e),t}}();Object.defineProperty(pr,"__esModule",{value:!0});pr.Chrome74=void 0;const Ie=Kt(se),ad=te,tn=Kt(ae),Et=Kt(J),Fs=Kt(fe),Ar=Kt(ze),od=Kt(zt),cd=de,dd=me,pd=we,ld=He,T=new ad.Logger("Chrome74"),ud="Chrome74",sn={OS:1024,MIS:1024};class ni extends dd.HandlerInterface{static createFactory(){return()=>new ni}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return ud}close(){if(T.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){T.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const s=Ie.parse(t.sdp),r=Fs.extractRtpCapabilities({sdpObject:s});return od.addNackSuppportForOpus(r),r}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return T.debug("getNativeSctpCapabilities()"),{numStreams:sn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){T.debug("run()"),this._direction=e,this._remoteSdp=new pd.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Et.getSendingRtpParameters("audio",c),video:Et.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Et.getSendingRemoteRtpParameters("audio",c),video:Et.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(T.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),T.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),T.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});T.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();T.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertNotClosed(),this.assertSendDirection(),T.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((m,w)=>{m.rid=`r${w}`});const n=tn.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=Et.reduceCodecs(n.codecs,r);const a=tn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);a.codecs=Et.reduceCodecs(a.codecs,r);const o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let p=await this._pc.createOffer(),c=Ie.parse(p.sdp),u;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c});let l=!1;const h=(0,ld.parse)((t??[{}])[0].scalabilityMode);t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(T.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,c=Ie.parse(p.sdp),u=c.media[o.idx],Ar.addLegacySimulcast({offerMediaObject:u,numStreams:h.spatialLayers}),p={type:"offer",sdp:Ie.write(c)}),T.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const f=d.mid;if(n.mid=f,c=Ie.parse(this._pc.localDescription.sdp),u=c.media[o.idx],n.rtcp.cname=Fs.getCname({offerMediaObject:u}),!t)n.encodings=Ar.getRtpEncodings({offerMediaObject:u});else if(t.length===1){let m=Ar.getRtpEncodings({offerMediaObject:u});Object.assign(m[0],t[0]),l&&(m=[m[0]]),n.encodings=m}else n.encodings=t;if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const m of n.encodings)m.scalabilityMode?m.scalabilityMode=`L1T${h.temporalLayers}`:m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:n,answerRtpParameters:a,codecOptions:s,extmapAllowMixed:!0});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return T.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),this._mapMidTransceiver.set(f,d),{localId:f,rtpParameters:n,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),T.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const r=await this._pc.createOffer();T.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const n={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();T.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();T.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?T.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):T.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();T.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();T.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};T.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%sn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Ie.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),T.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;T.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let n=await this._pc.createAnswer();const a=Ie.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);Fs.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Ie.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),T.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(c)this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const r of e){T.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();T.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){T.debug("pauseReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();T.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){T.debug("resumeReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();T.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};T.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Ie.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ie.parse(this._pc.localDescription.sdp));const s=Fs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new cd.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}pr.Chrome74=ni;var lr={},hd=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),fd=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),bs=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&hd(t,e,s[r]);return fd(t,e),t}}();Object.defineProperty(lr,"__esModule",{value:!0});lr.Chrome70=void 0;const Ce=bs(se),md=te,rn=bs(ae),Lt=bs(J),Bs=bs(fe),Fr=bs(ze),gd=me,_d=we,wd=He,j=new md.Logger("Chrome70"),vd="Chrome70",nn={OS:1024,MIS:1024};class ai extends gd.HandlerInterface{static createFactory(){return()=>new ai}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return vd}close(){if(j.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){j.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const s=Ce.parse(t.sdp);return Bs.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return j.debug("getNativeSctpCapabilities()"),{numStreams:nn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){j.debug("run()"),this._direction=e,this._remoteSdp=new _d.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Lt.getSendingRtpParameters("audio",c),video:Lt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Lt.getSendingRemoteRtpParameters("audio",c),video:Lt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(j.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){j.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(j.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});j.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();j.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertSendDirection(),j.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const n=rn.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=Lt.reduceCodecs(n.codecs,r);const a=rn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);a.codecs=Lt.reduceCodecs(a.codecs,r);const o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let p=await this._pc.createOffer(),c=Ce.parse(p.sdp),u;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),t&&t.length>1&&(j.debug("send() | enabling legacy simulcast"),c=Ce.parse(p.sdp),u=c.media[o.idx],Fr.addLegacySimulcast({offerMediaObject:u,numStreams:t.length}),p={type:"offer",sdp:Ce.write(c)});let l=!1;const h=(0,wd.parse)((t??[{}])[0].scalabilityMode);if(t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(j.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,c=Ce.parse(p.sdp),u=c.media[o.idx],Fr.addLegacySimulcast({offerMediaObject:u,numStreams:h.spatialLayers}),p={type:"offer",sdp:Ce.write(c)}),j.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),t){j.debug("send() | applying given encodings");const m=d.sender.getParameters();for(let w=0;w<(m.encodings??[]).length;++w){const N=m.encodings[w],b=t[w];if(!b)break;m.encodings[w]=Object.assign(N,b)}await d.sender.setParameters(m)}const f=d.mid;if(n.mid=f,c=Ce.parse(this._pc.localDescription.sdp),u=c.media[o.idx],n.rtcp.cname=Bs.getCname({offerMediaObject:u}),n.encodings=Fr.getRtpEncodings({offerMediaObject:u}),t)for(let m=0;m<n.encodings.length;++m)t[m]&&Object.assign(n.encodings[m],t[m]);if(l&&(n.encodings=[n.encodings[0]]),n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const m of n.encodings)m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:n,answerRtpParameters:a,codecOptions:s});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return j.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),this._mapMidTransceiver.set(f,d),{localId:f,rtpParameters:n,rtpSender:d.sender}}async stopSending(e){this.assertSendDirection(),j.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const r=await this._pc.createOffer();j.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const n={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?j.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):j.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),j.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();j.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),j.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();j.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:s,protocol:n};j.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%nn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Ce.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),j.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;j.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let n=await this._pc.createAnswer();const a=Ce.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);Bs.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Ce.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),j.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){this.assertRecvDirection();for(const r of e){j.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();j.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:s};j.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Ce.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ce.parse(this._pc.localDescription.sdp));const s=Bs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}lr.Chrome70=ai;var ur={},ft={};Object.defineProperty(ft,"__esModule",{value:!0});ft.getRtpEncodings=bd;ft.addLegacySimulcast=Sd;function bd({offerMediaObject:i,track:e}){const t=new Set;for(const n of i.ssrcs||[]){if(n.attribute!=="msid")continue;if(n.value.split(" ")[1]===e.id){const o=n.id;t.add(o)}}if(t.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);const s=new Map;for(const n of i.ssrcGroups||[]){if(n.semantics!=="FID")continue;let[a,o]=n.ssrcs.split(/\s+/);a=Number(a),o=Number(o),t.has(a)&&(t.delete(a),t.delete(o),s.set(a,o))}for(const n of t)s.set(n,null);const r=[];for(const[n,a]of s){const o={ssrc:n};a&&(o.rtx={ssrc:a}),r.push(o)}return r}function Sd({offerMediaObject:i,track:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");let s,r,n;if(!(i.ssrcs||[]).find(u=>u.attribute!=="msid"?!1:u.value.split(" ")[1]===e.id?(s=u.id,n=u.value.split(" ")[0],!0):!1))throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);(i.ssrcGroups||[]).some(u=>{if(u.semantics!=="FID")return!1;const l=u.ssrcs.split(/\s+/);return Number(l[0])===s?(r=Number(l[1]),!0):!1});const o=i.ssrcs.find(u=>u.attribute==="cname"&&u.id===s);if(!o)throw new Error(`a=ssrc line with cname information not found [track.id:${e.id}]`);const d=o.value,p=[],c=[];for(let u=0;u<t;++u)p.push(s+u),r&&c.push(r+u);i.ssrcGroups=i.ssrcGroups||[],i.ssrcs=i.ssrcs||[],i.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(const u of p)i.ssrcs.push({id:u,attribute:"cname",value:d}),i.ssrcs.push({id:u,attribute:"msid",value:`${n} ${e.id}`});for(let u=0;u<c.length;++u){const l=p[u],h=c[u];i.ssrcs.push({id:h,attribute:"cname",value:d}),i.ssrcs.push({id:h,attribute:"msid",value:`${n} ${e.id}`}),i.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${h}`})}}var yd=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Rd=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Ss=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&yd(t,e,s[r]);return Rd(t,e),t}}();Object.defineProperty(ur,"__esModule",{value:!0});ur.Chrome67=void 0;const Oe=Ss(se),Cd=te,an=Ss(ae),Mt=Ss(J),Us=Ss(fe),on=Ss(ft),Dd=me,Td=we,F=new Cd.Logger("Chrome67"),Pd="Chrome67",cn={OS:1024,MIS:1024};class oi extends Dd.HandlerInterface{static createFactory(){return()=>new oi}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return Pd}close(){if(F.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){F.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const s=Oe.parse(t.sdp);return Us.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return F.debug("getNativeSctpCapabilities()"),{numStreams:cn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){F.debug("run()"),this._direction=e,this._remoteSdp=new Td.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:Mt.getSendingRtpParameters("audio",c),video:Mt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Mt.getSendingRemoteRtpParameters("audio",c),video:Mt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(F.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){F.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(F.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});F.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();F.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertSendDirection(),F.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),r&&F.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let n=await this._pc.createOffer(),a=Oe.parse(n.sdp),o;const d=an.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=Mt.reduceCodecs(d.codecs);const p=an.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=Mt.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(F.debug("send() | enabling simulcast"),a=Oe.parse(n.sdp),o=a.media.find(h=>h.type==="video"),on.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:Oe.write(a)}),F.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=Oe.parse(this._pc.localDescription.sdp),o=a.media.find(h=>h.type===e.kind),d.rtcp.cname=Us.getCname({offerMediaObject:o}),d.encodings=on.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let h=0;h<d.encodings.length;++h)t[h]&&Object.assign(d.encodings[h],t[h]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const h of d.encodings)h.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:s});const c={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(u,l),{localId:u,rtpParameters:d,rtpSender:l}}async stopSending(e){this.assertSendDirection(),F.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const s=await this._pc.createOffer();F.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s);try{await this._pc.setLocalDescription(s)}catch(n){if(this._sendStream.getTracks().length===0){F.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const r={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?F.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):F.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapSendLocalIdRtpSender.get(e);if(!s)throw new Error("associated RTCRtpSender not found");const r=s.track;await s.replaceTrack(t),r&&this._sendStream.removeTrack(r),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),F.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapSendLocalIdRtpSender.get(e);if(!s)throw new Error("associated RTCRtpSender not found");const r=s.getParameters();r.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await s.setParameters(r)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),F.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapSendLocalIdRtpSender.get(e);if(!s)throw new Error("associated RTCRtpSender not found");const r=s.getParameters();r.encodings.forEach((n,a)=>{r.encodings[a]={...n,...t}}),await s.setParameters(r)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:s,protocol:n};F.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%cn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Oe.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),F.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[];for(const a of e){const{trackId:o,kind:d,rtpParameters:p,streamId:c}=a;F.debug("receive() [trackId:%s, kind:%s]",o,d);const u=d;this._remoteSdp.receive({mid:u,kind:d,offerRtpParameters:p,streamId:c??p.rtcp.cname,trackId:o})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);let r=await this._pc.createAnswer();const n=Oe.parse(r.sdp);for(const a of e){const{kind:o,rtpParameters:d}=a,p=o,c=n.media.find(u=>String(u.mid)===p);Us.applyCodecParameters({offerRtpParameters:d,answerMediaObject:c})}r={type:"answer",sdp:Oe.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),F.debug("receive() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const a of e){const{kind:o,trackId:d,rtpParameters:p}=a,c=d,u=o,l=this._pc.getReceivers().find(h=>h.track&&h.track.id===c);if(!l)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(c,{mid:u,rtpParameters:p,rtpReceiver:l}),t.push({localId:c,track:l.track,rtpReceiver:l})}return t}async stopReceiving(e){this.assertRecvDirection();for(const r of e){F.debug("stopReceiving() [localId:%s]",r);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(r)??{};this._mapRecvLocalIdInfo.delete(r),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();F.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)??{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:s};F.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Oe.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Oe.parse(this._pc.localDescription.sdp));const s=Us.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}ur.Chrome67=oi;var hr={},Ed=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Ld=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),ys=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Ed(t,e,s[r]);return Ld(t,e),t}}();Object.defineProperty(hr,"__esModule",{value:!0});hr.Chrome55=void 0;const ke=ys(se),Md=te,as=de,dn=ys(ae),xt=ys(J),zs=ys(fe),pn=ys(ft),xd=me,Id=we,z=new Md.Logger("Chrome55"),Od="Chrome55",ln={OS:1024,MIS:1024};class ci extends xd.HandlerInterface{static createFactory(){return()=>new ci}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return Od}close(){if(z.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){z.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const s=ke.parse(t.sdp);return zs.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return z.debug("getNativeSctpCapabilities()"),{numStreams:ln}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){z.debug("run()"),this._direction=e,this._remoteSdp=new Id.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:xt.getSendingRtpParameters("audio",c),video:xt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:xt.getSendingRemoteRtpParameters("audio",c),video:xt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(z.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){z.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(z.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});z.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();z.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertSendDirection(),z.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),r&&z.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let n=await this._pc.createOffer(),a=ke.parse(n.sdp),o;const d=dn.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=xt.reduceCodecs(d.codecs);const p=dn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=xt.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(z.debug("send() | enabling simulcast"),a=ke.parse(n.sdp),o=a.media.find(l=>l.type==="video"),pn.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:ke.write(a)}),z.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=ke.parse(this._pc.localDescription.sdp),o=a.media.find(l=>l.type===e.kind),d.rtcp.cname=zs.getCname({offerMediaObject:o}),d.encodings=pn.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let l=0;l<d.encodings.length;++l)t[l]&&Object.assign(d.encodings[l],t[l]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const l of d.encodings)l.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:s});const c={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:d}}async stopSending(e){this.assertSendDirection(),z.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const s=await this._pc.createOffer();z.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s);try{await this._pc.setLocalDescription(s)}catch(n){if(this._sendStream.getTracks().length===0){z.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const r={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new as.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new as.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new as.UnsupportedError("not supported")}async getSenderStats(e){throw new as.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:s,protocol:n};z.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ln.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=ke.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),z.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[];for(const a of e){const{trackId:o,kind:d,rtpParameters:p,streamId:c}=a;z.debug("receive() [trackId:%s, kind:%s]",o,d);const u=d;this._remoteSdp.receive({mid:u,kind:d,offerRtpParameters:p,streamId:c??p.rtcp.cname,trackId:o})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);let r=await this._pc.createAnswer();const n=ke.parse(r.sdp);for(const a of e){const{kind:o,rtpParameters:d}=a,p=o,c=n.media.find(u=>String(u.mid)===p);zs.applyCodecParameters({offerRtpParameters:d,answerMediaObject:c})}r={type:"answer",sdp:ke.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),z.debug("receive() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const a of e){const{kind:o,trackId:d,rtpParameters:p}=a,c=o,u=d,l=a.streamId??p.rtcp.cname,f=this._pc.getRemoteStreams().find(g=>g.id===l).getTrackById(u);if(!f)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(u,{mid:c,rtpParameters:p}),t.push({localId:u,track:f})}return t}async stopReceiving(e){this.assertRecvDirection();for(const r of e){z.debug("stopReceiving() [localId:%s]",r);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(r)??{};this._mapRecvLocalIdInfo.delete(r),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();z.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new as.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:s};z.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=ke.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}z.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ke.parse(this._pc.localDescription.sdp));const s=zs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}hr.Chrome55=ci;var fr={},kd=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),jd=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Rs=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&kd(t,e,s[r]);return jd(t,e),t}}();Object.defineProperty(fr,"__esModule",{value:!0});fr.Firefox120=void 0;const it=Rs(se),$d=te,un=de,hn=Rs(ae),It=Rs(J),Hs=Rs(fe),fn=Rs(ze),Nd=me,Ad=we,Fd=He,x=new $d.Logger("Firefox120"),Bd="Firefox120",mn={OS:16,MIS:2048};class di extends Nd.HandlerInterface{static createFactory(){return()=>new di}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return Bd}close(){if(x.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){x.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const r=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"}),e.addTransceiver(r,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const n=await e.createOffer();try{t.remove()}catch{}try{r.stop()}catch{}try{e.close()}catch{}const a=it.parse(n.sdp);return Hs.extractRtpCapabilities({sdpObject:a})}catch(n){try{t.remove()}catch{}try{r.stop()}catch{}try{e.close()}catch{}throw n}}async getNativeSctpCapabilities(){return x.debug("getNativeSctpCapabilities()"),{numStreams:mn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),x.debug("run()"),this._direction=e,this._remoteSdp=new Ad.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:It.getSendingRtpParameters("audio",c),video:It.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:It.getSendingRemoteRtpParameters("audio",c),video:It.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(x.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new un.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),x.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});x.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();x.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r,onRtpSender:n}){this.assertNotClosed(),this.assertSendDirection(),x.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((g,m)=>{g.rid=`r${m}`});const a=hn.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=It.reduceCodecs(a.codecs,r);const o=hn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=It.reduceCodecs(o.codecs,r);const d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});n&&n(d.sender);const p=await this._pc.createOffer();let c=it.parse(p.sdp);this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c});const u=(0,Fd.parse)((t??[{}])[0].scalabilityMode);x.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const l=d.mid;a.mid=l,c=it.parse(this._pc.localDescription.sdp);const h=c.media[c.media.length-1];if(a.rtcp.cname=Hs.getCname({offerMediaObject:h}),!t)a.encodings=fn.getRtpEncodings({offerMediaObject:h});else if(t.length===1){const g=fn.getRtpEncodings({offerMediaObject:h});Object.assign(g[0],t[0]),a.encodings=g}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const g of a.encodings)g.scalabilityMode?g.scalabilityMode=`L1T${u.temporalLayers}`:g.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:h,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s,extmapAllowMixed:!0});const f={type:"answer",sdp:this._remoteSdp.getSdp()};return x.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(l,d),{localId:l,rtpParameters:a,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),x.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const s=await this._pc.createOffer();x.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),x.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();x.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),x.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();x.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?x.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):x.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),x.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated transceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();x.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),x.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();x.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};x.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%mn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=it.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c}),x.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;x.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=s.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=it.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);Hs.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u}),n={type:"answer",sdp:it.write(a)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),x.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const r of e){x.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();x.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){x.debug("pauseReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();x.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){x.debug("resumeReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();x.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};x.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=it.parse(u.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:l})}x.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=it.parse(this._pc.localDescription.sdp));const s=Hs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new un.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}fr.Firefox120=di;var mr={},Ud=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),zd=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Cs=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Ud(t,e,s[r]);return zd(t,e),t}}();Object.defineProperty(mr,"__esModule",{value:!0});mr.Firefox60=void 0;const nt=Cs(se),Hd=te,gn=de,Br=Cs(ae),Ot=Cs(J),Ks=Cs(fe),_n=Cs(ze),Kd=me,Gd=we,Vd=He,I=new Hd.Logger("Firefox60"),qd="Firefox60",wn={OS:16,MIS:2048};class pi extends Kd.HandlerInterface{static createFactory(){return()=>new pi}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return qd}close(){if(I.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){I.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const r=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const n=e.addTransceiver(r,{direction:"sendrecv"}),a=n.sender.getParameters(),o=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];a.encodings=o,await n.sender.setParameters(a);const d=await e.createOffer();try{t.remove()}catch{}try{r.stop()}catch{}try{e.close()}catch{}const p=nt.parse(d.sdp);return Ks.extractRtpCapabilities({sdpObject:p})}catch(n){try{t.remove()}catch{}try{r.stop()}catch{}try{e.close()}catch{}throw n}}async getNativeSctpCapabilities(){return I.debug("getNativeSctpCapabilities()"),{numStreams:wn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),I.debug("run()"),this._direction=e,this._remoteSdp=new Gd.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Ot.getSendingRtpParameters("audio",c),video:Ot.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Ot.getSendingRemoteRtpParameters("audio",c),video:Ot.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(I.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new gn.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),I.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});I.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();I.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertNotClosed(),this.assertSendDirection(),I.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=Br.clone(t),t.forEach((f,g)=>{f.rid=`r${g}`}),t.reverse());const n=Br.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=Ot.reduceCodecs(n.codecs,r);const a=Br.clone(this._sendingRemoteRtpParametersByKind[e.kind]);a.codecs=Ot.reduceCodecs(a.codecs,r);const o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const f=o.sender.getParameters();f.encodings=t,await o.sender.setParameters(f)}const d=await this._pc.createOffer();let p=nt.parse(d.sdp);this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:p});const c=(0,Vd.parse)((t??[{}])[0].scalabilityMode);I.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);const u=o.mid;n.mid=u,p=nt.parse(this._pc.localDescription.sdp);const l=p.media[p.media.length-1];if(n.rtcp.cname=Ks.getCname({offerMediaObject:l}),!t)n.encodings=_n.getRtpEncodings({offerMediaObject:l});else if(t.length===1){const f=_n.getRtpEncodings({offerMediaObject:l});Object.assign(f[0],t[0]),n.encodings=f}else n.encodings=t.reverse();if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const f of n.encodings)f.scalabilityMode?f.scalabilityMode=`L1T${c.temporalLayers}`:f.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,offerRtpParameters:n,answerRtpParameters:a,codecOptions:s,extmapAllowMixed:!0});const h={type:"answer",sdp:this._remoteSdp.getSdp()};return I.debug("send() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setRemoteDescription(h),this._mapMidTransceiver.set(u,o),{localId:u,rtpParameters:n,rtpSender:o.sender}}async stopSending(e){if(this.assertSendDirection(),I.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const s=await this._pc.createOffer();I.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),I.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();I.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),I.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();I.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?I.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):I.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),I.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated transceiver not found");const r=s.sender.getParameters();t=r.encodings.length-1-t,r.encodings.forEach((o,d)=>{d>=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();I.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),I.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();I.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};I.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%wn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=nt.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c}),I.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;I.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let n=await this._pc.createAnswer();const a=nt.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);Ks.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u}),n={type:"answer",sdp:nt.write(a)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),I.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const r of e){I.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();I.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){I.debug("pauseReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();I.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){I.debug("resumeReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();I.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};I.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=nt.parse(u.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:l})}I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=nt.parse(this._pc.localDescription.sdp));const s=Ks.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new gn.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}mr.Firefox60=pi;var gr={},Qd=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Wd=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Gt=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Qd(t,e,s[r]);return Wd(t,e),t}}();Object.defineProperty(gr,"__esModule",{value:!0});gr.Safari12=void 0;const je=Gt(se),Xd=te,vn=Gt(ae),kt=Gt(J),Gs=Gt(fe),bn=Gt(ze),Yd=Gt(zt),Jd=de,Zd=me,ep=we,tp=He,P=new Xd.Logger("Safari12"),sp="Safari12",Sn={OS:1024,MIS:1024};class li extends Zd.HandlerInterface{static createFactory(){return()=>new li}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return sp}close(){if(P.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){P.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const s=je.parse(t.sdp),r=Gs.extractRtpCapabilities({sdpObject:s});return Yd.addNackSuppportForOpus(r),r}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return P.debug("getNativeSctpCapabilities()"),{numStreams:Sn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),P.debug("run()"),this._direction=e,this._remoteSdp=new ep.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:kt.getSendingRtpParameters("audio",c),video:kt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:kt.getSendingRemoteRtpParameters("audio",c),video:kt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(P.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),P.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),P.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});P.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();P.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r,onRtpSender:n}){this.assertNotClosed(),this.assertSendDirection(),P.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const a=vn.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=kt.reduceCodecs(a.codecs,r);const o=vn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=kt.reduceCodecs(o.codecs,r);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});n&&n(p.sender);let c=await this._pc.createOffer(),u=je.parse(c.sdp),l;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u});const h=(0,tp.parse)((t??[{}])[0].scalabilityMode);t&&t.length>1&&(P.debug("send() | enabling legacy simulcast"),u=je.parse(c.sdp),l=u.media[d.idx],bn.addLegacySimulcast({offerMediaObject:l,numStreams:t.length}),c={type:"offer",sdp:je.write(u)}),P.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const f=p.mid;if(a.mid=f,u=je.parse(this._pc.localDescription.sdp),l=u.media[d.idx],a.rtcp.cname=Gs.getCname({offerMediaObject:l}),a.encodings=bn.getRtpEncodings({offerMediaObject:l}),t)for(let m=0;m<a.encodings.length;++m)t[m]&&Object.assign(a.encodings[m],t[m]);if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const m of a.encodings)m.scalabilityMode?m.scalabilityMode=`L1T${h.temporalLayers}`:m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return P.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),this._mapMidTransceiver.set(f,p),{localId:f,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;P.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const r=await this._pc.createOffer();P.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const n={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();P.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();P.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?P.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):P.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();P.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();P.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};P.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Sn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=je.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),P.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;P.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=s.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=je.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);Gs.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:je.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),P.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const r of e){P.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();P.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){P.debug("pauseReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();P.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){P.debug("resumeReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();P.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};P.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=je.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=je.parse(this._pc.localDescription.sdp));const s=Gs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Jd.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}gr.Safari12=li;var _r={},rp=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),ip=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Ds=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&rp(t,e,s[r]);return ip(t,e),t}}();Object.defineProperty(_r,"__esModule",{value:!0});_r.Safari11=void 0;const $e=Ds(se),np=te,yn=Ds(ae),jt=Ds(J),Vs=Ds(fe),Rn=Ds(ft),ap=me,op=we,B=new np.Logger("Safari11"),cp="Safari11",Cn={OS:1024,MIS:1024};class ui extends ap.HandlerInterface{static createFactory(){return()=>new ui}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return cp}close(){if(B.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){B.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const s=$e.parse(t.sdp);return Vs.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return B.debug("getNativeSctpCapabilities()"),{numStreams:Cn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){B.debug("run()"),this._direction=e,this._remoteSdp=new op.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:jt.getSendingRtpParameters("audio",c),video:jt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:jt.getSendingRemoteRtpParameters("audio",c),video:jt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(B.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){B.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(B.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});B.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();B.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertSendDirection(),B.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),r&&B.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let n=await this._pc.createOffer(),a=$e.parse(n.sdp),o;const d=yn.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=jt.reduceCodecs(d.codecs);const p=yn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=jt.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(B.debug("send() | enabling simulcast"),a=$e.parse(n.sdp),o=a.media.find(h=>h.type==="video"),Rn.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:$e.write(a)}),B.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=$e.parse(this._pc.localDescription.sdp),o=a.media.find(h=>h.type===e.kind),d.rtcp.cname=Vs.getCname({offerMediaObject:o}),d.encodings=Rn.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let h=0;h<d.encodings.length;++h)t[h]&&Object.assign(d.encodings[h],t[h]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const h of d.encodings)h.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:s});const c={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(u,l),{localId:u,rtpParameters:d,rtpSender:l}}async stopSending(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const s=await this._pc.createOffer();B.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s);try{await this._pc.setLocalDescription(s)}catch(n){if(this._sendStream.getTracks().length===0){B.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const r={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?B.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):B.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapSendLocalIdRtpSender.get(e);if(!s)throw new Error("associated RTCRtpSender not found");const r=s.track;await s.replaceTrack(t),r&&this._sendStream.removeTrack(r),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),B.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapSendLocalIdRtpSender.get(e);if(!s)throw new Error("associated RTCRtpSender not found");const r=s.getParameters();r.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await s.setParameters(r)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),B.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapSendLocalIdRtpSender.get(e);if(!s)throw new Error("associated RTCRtpSender not found");const r=s.getParameters();r.encodings.forEach((n,a)=>{r.encodings[a]={...n,...t}}),await s.setParameters(r)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};B.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Cn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=$e.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),B.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[];for(const a of e){const{trackId:o,kind:d,rtpParameters:p,streamId:c}=a;B.debug("receive() [trackId:%s, kind:%s]",o,d);const u=d;this._remoteSdp.receive({mid:u,kind:d,offerRtpParameters:p,streamId:c??p.rtcp.cname,trackId:o})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);let r=await this._pc.createAnswer();const n=$e.parse(r.sdp);for(const a of e){const{kind:o,rtpParameters:d}=a,p=o,c=n.media.find(u=>String(u.mid)===p);Vs.applyCodecParameters({offerRtpParameters:d,answerMediaObject:c})}r={type:"answer",sdp:$e.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),B.debug("receive() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const a of e){const{kind:o,trackId:d,rtpParameters:p}=a,c=o,u=d,l=this._pc.getReceivers().find(h=>h.track&&h.track.id===u);if(!l)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(u,{mid:c,rtpParameters:p,rtpReceiver:l}),t.push({localId:u,track:l.track,rtpReceiver:l})}return t}async stopReceiving(e){this.assertRecvDirection();for(const r of e){B.debug("stopReceiving() [localId:%s]",r);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(r)??{};this._mapRecvLocalIdInfo.delete(r),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();B.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)??{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async pauseReceiving(e){}async resumeReceiving(e){}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};B.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=$e.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}B.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=$e.parse(this._pc.localDescription.sdp));const s=Vs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}_r.Safari11=ui;var wr={},vr={},dp=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),pp=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),lp=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&dp(t,e,s[r]);return pp(t,e),t}}();Object.defineProperty(vr,"__esModule",{value:!0});vr.getCapabilities=up;vr.mangleRtpParameters=hp;const ia=lp(ae);function up(){const i=RTCRtpReceiver.getCapabilities(),e=ia.clone(i);for(const t of e.codecs??[]){if(t.channels=t.numChannels,delete t.numChannels,t.mimeType=t.mimeType??`${t.kind}/${t.name}`,t.parameters){const s=t.parameters;s.apt&&(s.apt=Number(s.apt)),s["packetization-mode"]&&(s["packetization-mode"]=Number(s["packetization-mode"]))}for(const s of t.rtcpFeedback??[])s.parameter||(s.parameter="")}return e}function hp(i){const e=ia.clone(i);e.mid&&(e.muxId=e.mid,delete e.mid);for(const t of e.codecs)t.channels&&(t.numChannels=t.channels,delete t.channels),t.mimeType&&!t.name&&(t.name=t.mimeType.split("/")[1]),delete t.mimeType;return e}var fp=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),mp=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),hi=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&fp(t,e,s[r]);return mp(t,e),t}}();Object.defineProperty(wr,"__esModule",{value:!0});wr.Edge11=void 0;const gp=te,Ur=de,qs=hi(ae),zr=hi(J),Hr=hi(vr),_p=me,G=new gp.Logger("Edge11"),wp="Edge11";class fi extends _p.HandlerInterface{static createFactory(){return()=>new fi}constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}get name(){return wp}close(){G.debug("close()");try{this._iceGatherer.close()}catch{}try{this._iceTransport.stop()}catch{}try{this._dtlsTransport.stop()}catch{}for(const e of this._rtpSenders.values())try{e.stop()}catch{}for(const e of this._rtpReceivers.values())try{e.stop()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){return G.debug("getNativeRtpCapabilities()"),Hr.getCapabilities()}async getNativeSctpCapabilities(){return G.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){G.debug("run()"),this._sendingRtpParametersByKind={audio:zr.getSendingRtpParameters("audio",c),video:zr.getSendingRtpParameters("video",c)},this._remoteIceParameters=t,this._remoteIceCandidates=s,this._remoteDtlsParameters=r,this._cname=`CNAME-${qs.generateRandomNumber()}`,this.setIceGatherer({iceServers:a,iceTransportPolicy:o}),this.setIceTransport(),this.setDtlsTransport()}async updateIceServers(e){throw new Ur.UnsupportedError("not supported")}async restartIce(e){if(G.debug("restartIce()"),this._remoteIceParameters=e,!!this._transportReady){G.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const t of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(t);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){G.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),G.debug("send() | calling new RTCRtpSender()");const n=new RTCRtpSender(e,this._dtlsTransport),a=qs.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=zr.reduceCodecs(a.codecs,r);const o=a.codecs.some(c=>/.+\/rtx$/i.test(c.mimeType));t||(t=[{}]);for(const c of t)c.ssrc=qs.generateRandomNumber(),o&&(c.rtx={ssrc:qs.generateRandomNumber()});a.encodings=t,a.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const d=Hr.mangleRtpParameters(a);G.debug("send() | calling rtpSender.send() [params:%o]",d),await n.send(d);const p=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(p,n),{localId:p,rtpParameters:a,rtpSender:n}}async stopSending(e){G.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{G.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(s){throw G.warn("stopSending() | rtpSender.stop() failed:%o",s),s}}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){t?G.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):G.debug("replaceTrack() [localId:%s, no track]",e);const s=this._rtpSenders.get(e);if(!s)throw new Error("RTCRtpSender not found");s.setTrack(t)}async setMaxSpatialLayer(e,t){G.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._rtpSenders.get(e);if(!s)throw new Error("RTCRtpSender not found");const r=s.getParameters();r.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await s.setParameters(r)}async setRtpEncodingParameters(e,t){G.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._rtpSenders.get(e);if(!s)throw new Error("RTCRtpSender not found");const r=s.getParameters();r.encodings.forEach((n,a)=>{r.encodings[a]={...n,...t}}),await s.setParameters(r)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new Ur.UnsupportedError("not implemented")}async receive(e){const t=[];for(const s of e){const{trackId:r,kind:n}=s;G.debug("receive() [trackId:%s, kind:%s]",r,n)}this._transportReady||await this.setupTransport({localDtlsRole:"server"});for(const s of e){const{trackId:r,kind:n,rtpParameters:a}=s;G.debug("receive() | calling new RTCRtpReceiver()");const o=new RTCRtpReceiver(this._dtlsTransport,n);o.addEventListener("error",c=>{G.error('rtpReceiver "error" event [event:%o]',c)});const d=Hr.mangleRtpParameters(a);G.debug("receive() | calling rtpReceiver.receive() [params:%o]",d),await o.receive(d);const p=r;this._rtpReceivers.set(p,o),t.push({localId:p,track:o.track,rtpReceiver:o})}return t}async stopReceiving(e){for(const t of e){G.debug("stopReceiving() [localId:%s]",t);const s=this._rtpReceivers.get(t);if(!s)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(t);try{G.debug("stopReceiving() | calling rtpReceiver.stop()"),s.stop()}catch(r){G.warn("stopReceiving() | rtpReceiver.stop() failed:%o",r)}}}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new Ur.UnsupportedError("not implemented")}setIceGatherer({iceServers:e,iceTransportPolicy:t}){const s=new RTCIceGatherer({iceServers:e??[],gatherPolicy:t??"all"});s.addEventListener("error",r=>{G.error('iceGatherer "error" event [event:%o]',r)});try{s.gather()}catch(r){G.debug("setIceGatherer() | iceGatherer.gather() failed: %s",r.toString())}this._iceGatherer=s}setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("candidatepairchange",t=>{G.debug('iceTransport "candidatepairchange" event [pair:%o]',t.pair)}),this._iceTransport=e}setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{G.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{G.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),e.state==="closed"&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",t=>{G.error('dtlsTransport "error" event [event:%o]',t)}),this._dtlsTransport=e}async setupTransport({localDtlsRole:e}){G.debug("setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await new Promise((s,r)=>{this.safeEmit("@connect",{dtlsParameters:t},s,r)}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const s of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(s);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(s=>s.algorithm==="sha-256"||s.algorithm==="sha-384"||s.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}wr.Edge11=fi;var br={},vp=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),bp=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Vt=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&vp(t,e,s[r]);return bp(t,e),t}}();Object.defineProperty(br,"__esModule",{value:!0});br.ReactNativeUnifiedPlan=void 0;const Ne=Vt(se),Sp=te,Dn=Vt(ae),$t=Vt(J),Qs=Vt(fe),Kr=Vt(ze),yp=Vt(zt),Rp=de,Cp=me,Dp=we,Tp=He,D=new Sp.Logger("ReactNativeUnifiedPlan"),Pp="ReactNativeUnifiedPlan",Tn={OS:1024,MIS:1024};class mi extends Cp.HandlerInterface{static createFactory(){return()=>new mi}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return Pp}close(){if(D.debug("close()"),!this._closed){if(this._closed=!0,this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){D.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const s=Ne.parse(t.sdp),r=Qs.extractRtpCapabilities({sdpObject:s});return yp.addNackSuppportForOpus(r),r}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return D.debug("getNativeSctpCapabilities()"),{numStreams:Tn}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),D.debug("run()"),this._direction=e,this._remoteSdp=new Dp.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n}),this._sendingRtpParametersByKind={audio:$t.getSendingRtpParameters("audio",c),video:$t.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:$t.getSendingRemoteRtpParameters("audio",c),video:$t.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(D.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),D.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),D.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});D.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();D.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r,onRtpSender:n}){this.assertNotClosed(),this.assertSendDirection(),D.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((w,N)=>{w.rid=`r${N}`});const a=Dn.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=$t.reduceCodecs(a.codecs,r);const o=Dn.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=$t.reduceCodecs(o.codecs,r);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});n&&n(p.sender);let c=await this._pc.createOffer(),u=Ne.parse(c.sdp),l;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u});let h=!1;const f=(0,Tp.parse)((t??[{}])[0].scalabilityMode);t&&t.length===1&&f.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(D.debug("send() | enabling legacy simulcast for VP9 SVC"),h=!0,u=Ne.parse(c.sdp),l=u.media[d.idx],Kr.addLegacySimulcast({offerMediaObject:l,numStreams:f.spatialLayers}),c={type:"offer",sdp:Ne.write(u)}),D.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);let g=p.mid??void 0;if(g||D.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),a.mid=g,u=Ne.parse(this._pc.localDescription.sdp),l=u.media[d.idx],a.rtcp.cname=Qs.getCname({offerMediaObject:l}),!t)a.encodings=Kr.getRtpEncodings({offerMediaObject:l});else if(t.length===1){let w=Kr.getRtpEncodings({offerMediaObject:l});Object.assign(w[0],t[0]),h&&(w=[w[0]]),a.encodings=w}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const w of a.encodings)w.scalabilityMode?w.scalabilityMode=`L1T${f.temporalLayers}`:w.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s,extmapAllowMixed:!0});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return D.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),g||(g=p.mid,a.mid=g),this._mapMidTransceiver.set(g,p),{localId:g,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;D.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const r=await this._pc.createOffer();D.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const n={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();D.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();D.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const r={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?D.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):D.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();D.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const r=s.sender.getParameters();r.encodings.forEach((o,d)=>{r.encodings[d]={...o,...t}}),await s.sender.setParameters(r),this._remoteSdp.muxMediaSectionSimulcast(e,r.encodings);const n=await this._pc.createOffer();D.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};D.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Tn.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Ne.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),D.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;D.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid??String(this._mapMidTransceiver.size);s.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u??c.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=s.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=Ne.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=s.get(d),u=a.media.find(l=>String(l.mid)===c);Qs.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Ne.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),D.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=s.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(c)this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const r of e){D.debug("stopReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();D.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const r of e)this._mapMidTransceiver.delete(r)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){D.debug("pauseReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();D.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const r of e){D.debug("resumeReceiving() [localId:%s]",r);const n=this._mapMidTransceiver.get(r);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(r)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();D.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};D.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Ne.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ne.parse(this._pc.localDescription.sdp));const s=Qs.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Rp.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}br.ReactNativeUnifiedPlan=mi;var Sr={},Ep=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),Lp=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Ts=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&Ep(t,e,s[r]);return Lp(t,e),t}}();Object.defineProperty(Sr,"__esModule",{value:!0});Sr.ReactNative=void 0;const Ae=Ts(se),Mp=te,os=de,Gr=Ts(ae),Nt=Ts(J),Ws=Ts(fe),Pn=Ts(ft),xp=me,Ip=we,U=new Mp.Logger("ReactNative"),Op="ReactNative",En={OS:1024,MIS:1024};class gi extends xp.HandlerInterface{static createFactory(){return()=>new gi}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return Op}close(){if(U.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){U.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const s=Ae.parse(t.sdp);return Ws.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return U.debug("getNativeSctpCapabilities()"),{numStreams:En}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){U.debug("run()"),this._direction=e,this._remoteSdp=new Ip.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:Nt.getSendingRtpParameters("audio",c),video:Nt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Nt.getSendingRemoteRtpParameters("audio",c),video:Nt.getSendingRemoteRtpParameters("video",c)},r.role&&r.role!=="auto"&&(this._forcedLocalDtlsRole=r.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:o??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(U.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){U.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(U.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});U.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();U.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:r}){this.assertSendDirection(),U.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),r&&U.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let n=await this._pc.createOffer(),a=Ae.parse(n.sdp),o;const d=Gr.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=Nt.reduceCodecs(d.codecs);const p=Gr.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=Nt.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(U.debug("send() | enabling simulcast"),a=Ae.parse(n.sdp),o=a.media.find(l=>l.type==="video"),Pn.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:Ae.write(a)}),U.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=Ae.parse(this._pc.localDescription.sdp),o=a.media.find(l=>l.type===e.kind),d.rtcp.cname=Ws.getCname({offerMediaObject:o}),d.encodings=Pn.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let l=0;l<d.encodings.length;++l)t[l]&&Object.assign(d.encodings[l],t[l]);if(d.encodings.length>1&&(d.codecs[0].mimeType.toLowerCase()==="video/vp8"||d.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const l of d.encodings)l.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:s});const c={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:d}}async stopSending(e){this.assertSendDirection(),U.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const s=await this._pc.createOffer();U.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s);try{await this._pc.setLocalDescription(s)}catch(n){if(this._sendStream.getTracks().length===0){U.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const r={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new os.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new os.UnsupportedError("not implemented")}async setRtpEncodingParameters(e,t){throw new os.UnsupportedError("not implemented")}async getSenderStats(e){throw new os.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:r,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:s,protocol:n};U.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(r,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%En.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Ae.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),U.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c}=o;U.debug("receive() [trackId:%s, kind:%s]",d,p);const u=p;let l=o.streamId??c.rtcp.cname;U.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),l+=`-hack-${Gr.generateRandomNumber()}`,s.set(d,l),this._remoteSdp.receive({mid:u,kind:p,offerRtpParameters:c,streamId:l,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let n=await this._pc.createAnswer();const a=Ae.parse(n.sdp);for(const o of e){const{kind:d,rtpParameters:p}=o,c=d,u=a.media.find(l=>String(l.mid)===c);Ws.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Ae.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),U.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{kind:d,trackId:p,rtpParameters:c}=o,u=p,l=d,h=s.get(p),g=this._pc.getRemoteStreams().find(m=>m.id===h).getTrackById(u);if(!g)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(u,{mid:l,rtpParameters:c}),t.push({localId:u,track:g})}return t}async stopReceiving(e){this.assertRecvDirection();for(const r of e){U.debug("stopReceiving() [localId:%s]",r);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(r)??{};this._mapRecvLocalIdInfo.delete(r),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();U.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new os.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertRecvDirection();const{streamId:r,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:r,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:s};U.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Ae.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}U.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ae.parse(this._pc.localDescription.sdp));const s=Ws.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((r,n)=>{this.safeEmit("@connect",{dtlsParameters:s},r,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Sr.ReactNative=gi;var kp=_&&_.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var r=Object.getOwnPropertyDescriptor(e,t);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,r)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),jp=_&&_.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),na=_&&_.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var s=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[s.length]=r);return s},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=i(e),r=0;r<s.length;r++)s[r]!=="default"&&kp(t,e,s[r]);return jp(t,e),t}}();Object.defineProperty(Ut,"__esModule",{value:!0});Ut.Device=void 0;Ut.detectDevice=aa;const $p=Va,Np=te,Ap=Ue,At=de,Ln=na(ae),at=na(J),Fp=ms,Bp=dr,Up=pr,zp=lr,Hp=ur,Kp=hr,Gp=fr,Vp=mr,qp=gr,Qp=_r,Wp=wr,Xp=br,Yp=Sr,ue=new Np.Logger("Device");function aa(i){var e,t,s,r;if(!i&&typeof navigator=="object"&&navigator.product==="ReactNative"){if(ue.debug("detectDevice() | React-Native detected"),typeof RTCPeerConnection>"u"){ue.warn("detectDevice() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?");return}return typeof RTCRtpTransceiver<"u"?(ue.debug("detectDevice() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(ue.debug("detectDevice() | ReactNative PlanB handler chosen"),"ReactNative")}else if(i||typeof navigator=="object"&&typeof navigator.userAgent=="string"){i??(i=navigator.userAgent);const n=new $p.UAParser(i);ue.debug("detectDevice() | browser detected [userAgent:%s, parsed:%o]",i,n.getResult());const a=n.getBrowser(),o=(e=a.name)==null?void 0:e.toLowerCase(),d=parseInt(a.major??"0"),c=(t=n.getEngine().name)==null?void 0:t.toLowerCase(),u=n.getOS(),l=(s=u.name)==null?void 0:s.toLowerCase(),h=parseFloat(u.version??"0"),g=(r=n.getDevice().model)==null?void 0:r.toLowerCase(),m=l==="ios"||g==="ipad",w=o&&["chrome","chromium","mobile chrome","chrome webview","chrome headless"].includes(o),N=o&&["firefox","mobile firefox","mobile focus"].includes(o),b=o&&["safari","mobile safari"].includes(o),E=o&&["edge"].includes(o);if((w||E)&&!m&&d>=111)return"Chrome111";if(w&&!m&&d>=74||E&&!m&&d>=88)return"Chrome74";if(w&&!m&&d>=70)return"Chrome70";if(w&&!m&&d>=67)return"Chrome67";if(w&&!m&&d>=55)return"Chrome55";if(N&&!m&&d>=120)return"Firefox120";if(N&&!m&&d>=60)return"Firefox60";if(N&&m&&h>=14.3)return"Safari12";if(b&&d>=12&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(b&&d>=11)return"Safari11";if(E&&!m&&d>=11&&d<=18)return"Edge11";if(c==="webkit"&&m&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(c==="blink"){const K=i.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(K){const ee=Number(K[1]);return ee>=111?"Chrome111":ee>=74?"Chrome74":ee>=70?"Chrome70":ee>=67?"Chrome67":"Chrome55"}else return"Chrome111"}else{ue.warn("detectDevice() | browser not supported [name:%s, version:%s]",o,d);return}}else{ue.warn("detectDevice() | unknown device");return}}class Jp{constructor({handlerName:e,handlerFactory:t}={}){if(this._loaded=!1,this._observer=new Ap.EnhancedEventEmitter,ue.debug("constructor()"),e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)ue.debug("constructor() | handler given: %s",e);else if(e=aa(),e)ue.debug("constructor() | detected handler: %s",e);else throw new At.UnsupportedError("device not supported");switch(e){case"Chrome111":{this._handlerFactory=Bp.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=Up.Chrome74.createFactory();break}case"Chrome70":{this._handlerFactory=zp.Chrome70.createFactory();break}case"Chrome67":{this._handlerFactory=Hp.Chrome67.createFactory();break}case"Chrome55":{this._handlerFactory=Kp.Chrome55.createFactory();break}case"Firefox120":{this._handlerFactory=Gp.Firefox120.createFactory();break}case"Firefox60":{this._handlerFactory=Vp.Firefox60.createFactory();break}case"Safari12":{this._handlerFactory=qp.Safari12.createFactory();break}case"Safari11":{this._handlerFactory=Qp.Safari11.createFactory();break}case"Edge11":{this._handlerFactory=Wp.Edge11.createFactory();break}case"ReactNativeUnifiedPlan":{this._handlerFactory=Xp.ReactNativeUnifiedPlan.createFactory();break}case"ReactNative":{this._handlerFactory=Yp.ReactNative.createFactory();break}default:throw new TypeError(`unknown handlerName "${e}"`)}}const s=this._handlerFactory();this._handlerName=s.name,s.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new At.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new At.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){ue.debug("load() [routerRtpCapabilities:%o]",e);let t;try{if(this._loaded)throw new At.InvalidStateError("already loaded");const s=Ln.clone(e);at.validateRtpCapabilities(s),t=this._handlerFactory();const r=await t.getNativeRtpCapabilities();ue.debug("load() | got native RTP capabilities:%o",r);const n=Ln.clone(r);at.validateRtpCapabilities(n),this._extendedRtpCapabilities=at.getExtendedRtpCapabilities(n,s),ue.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=at.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=at.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=at.getRecvRtpCapabilities(this._extendedRtpCapabilities),at.validateRtpCapabilities(this._recvRtpCapabilities),ue.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),ue.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),at.validateSctpCapabilities(this._sctpCapabilities),ue.debug("load() succeeded"),this._loaded=!0,t.close()}catch(s){throw t&&t.close(),s}}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new At.InvalidStateError("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c}){return ue.debug("createSendTransport()"),this.createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c})}createRecvTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c}){return ue.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:r,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c})}createTransport({direction:e,id:t,iceParameters:s,iceCandidates:r,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:c,appData:u}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof s!="object")throw new TypeError("missing iceParameters");if(Array.isArray(r)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(u&&typeof u!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new At.InvalidStateError("not loaded");const l=new Fp.Transport({direction:e,id:t,iceParameters:s,iceCandidates:r,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:c,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",l),l}}Ut.Device=Jp;var oa={},ca={};Object.defineProperty(ca,"__esModule",{value:!0});var da={};Object.defineProperty(da,"__esModule",{value:!0});(function(i){var e=_&&_.__createBinding||(Object.create?function(s,r,n,a){a===void 0&&(a=n);var o=Object.getOwnPropertyDescriptor(r,n);(!o||("get"in o?!r.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return r[n]}}),Object.defineProperty(s,a,o)}:function(s,r,n,a){a===void 0&&(a=n),s[a]=r[n]}),t=_&&_.__exportStar||function(s,r){for(var n in s)n!=="default"&&!Object.prototype.hasOwnProperty.call(r,n)&&e(r,s,n)};Object.defineProperty(i,"__esModule",{value:!0}),t(Ut,i),t(ms,i),t(gs,i),t(_s,i),t(ws,i),t(vs,i),t(ca,i),t(da,i),t(me,i),t(de,i)})(oa);(function(i){var e=_&&_.__createBinding||(Object.create?function(p,c,u,l){l===void 0&&(l=u);var h=Object.getOwnPropertyDescriptor(c,u);(!h||("get"in h?!c.__esModule:h.writable||h.configurable))&&(h={enumerable:!0,get:function(){return c[u]}}),Object.defineProperty(p,l,h)}:function(p,c,u,l){l===void 0&&(l=u),p[l]=c[u]}),t=_&&_.__setModuleDefault||(Object.create?function(p,c){Object.defineProperty(p,"default",{enumerable:!0,value:c})}:function(p,c){p.default=c}),s=_&&_.__importStar||function(){var p=function(c){return p=Object.getOwnPropertyNames||function(u){var l=[];for(var h in u)Object.prototype.hasOwnProperty.call(u,h)&&(l[l.length]=h);return l},p(c)};return function(c){if(c&&c.__esModule)return c;var u={};if(c!=null)for(var l=p(c),h=0;h<l.length;h++)l[h]!=="default"&&e(u,c,l[h]);return t(u,c),u}}(),r=_&&_.__importDefault||function(p){return p&&p.__esModule?p:{default:p}};Object.defineProperty(i,"__esModule",{value:!0}),i.debug=i.parseScalabilityMode=i.detectDevice=i.Device=i.version=i.types=void 0;const n=r(sr);i.debug=n.default;const a=Ut;Object.defineProperty(i,"Device",{enumerable:!0,get:function(){return a.Device}}),Object.defineProperty(i,"detectDevice",{enumerable:!0,get:function(){return a.detectDevice}});const o=s(oa);i.types=o,i.version="3.8.1";var d=He;Object.defineProperty(i,"parseScalabilityMode",{enumerable:!0,get:function(){return d.parse}})})(An);let ye=null,pa=null,Bt=null,hs=null,Mn=[],Zp={encodings:[{rid:"r0",maxBitrate:1e5,scalabilityMode:"S1T3"},{rid:"r1",maxBitrate:3e5,scalabilityMode:"S1T3"},{rid:"r2",maxBitrate:9e5,scalabilityMode:"S1T3"}],codecOptions:{videoGoogleStartBitrate:1e3}},xn=null,er=null,Xs=null,Ys=null;const In=()=>{debugger;ye=Nn("https://admin.dianlvtong.xyz:3001/mediasoup"),ye.on("connect",()=>{console.log("client socket connected")}),ye.on("connected-success",({socketId:i})=>{console.log("connected-success socketId",i),el()}),ye.on("new-producer",({producerId:i})=>la(i))},el=async()=>{const i={audio:!0,video:{width:1280,height:720}},e=document.querySelector("#local-video");try{er=await navigator.mediaDevices.getUserMedia(i),e.srcObject=er,tl()}catch(t){console.log(t)}},tl=()=>{ye.emit("joinRoom",{roomName:1},i=>{console.log("Router RtpCapabilities: ",i.rtpCapabilities),pa=i.rtpCapabilities,sl()})},sl=async()=>{try{Bt=new An.Device,await Bt.load({routerRtpCapabilities:pa}),console.log("Device RTP Capabilities",Bt.rtpCapabilities),rl()}catch(i){console.log(i),i.name==="UnsupportedError"&&console.warn("browser not supported")}},rl=()=>{ye.emit("createWebRtcTransport",{consumer:!1},({params:i})=>{if(i.error){console.log(i.error);return}console.log("createSendTransport:",i),hs=Bt.createSendTransport(i),hs.on("connect",async({dtlsParameters:e},t,s)=>{console.log("createSendTransport-connect:",e);try{await ye.emit("transport-connect",{dtlsParameters:e}),t()}catch(r){s(r)}}),hs.on("produce",async(e,t,s)=>{console.log("createSendTransport-produce",e);try{await ye.emit("transport-produce",{kind:e.kind,rtpParameters:e.rtpParameters,appData:e.appData},({id:r,producersExist:n})=>{t({id:r}),console.log("=============producersExist========",n),n&&il()})}catch(r){s(r)}}),nl()})},il=()=>{ye.emit("getProducers",i=>{console.log("getProducers",i),i.forEach(e=>la(e))})};async function nl(){const i=er.getVideoTracks()[0],e=er.getAudioTracks()[0];console.log("video track",i),console.log("audio track",e),Xs=await hs.produce({...Zp,track:i}),Xs.on("trackended",()=>{console.log("track ended")}),Xs.on("transportclose",()=>{console.log("transport ended"),Xs=null}),Ys=await hs.produce({track:e,codecOptions:{opusStereo:!0,opusDtx:!0,opusFec:!0,opusNack:!0}}),Ys.on("trackended",()=>{console.log("track ended")}),Ys.on("transportclose",()=>{console.log("transport ended"),Ys=null})}const la=async i=>{await ye.emit("createWebRtcTransport",{consumer:!0},({params:e})=>{if(e.error){console.log(e.error);return}console.log(e);const t=Bt.createRecvTransport(e);t.on("connect",async({dtlsParameters:s},r,n)=>{try{await ye.emit("transport-recv-connect",{dtlsParameters:s,serverConsumerTransportId:e.id}),r()}catch(a){n(a)}}),al(t,i,e.id)})},al=async(i,e,t)=>{await ye.emit("consume",{rtpCapabilities:Bt.rtpCapabilities,remoteProducerId:e,serverConsumerTransportId:t},async({params:s})=>{if(console.log(s),s.error){console.log("Cannot Consume");return}const r=await i.consume({id:s.id,producerId:s.producerId,kind:s.kind,rtpParameters:s.rtpParameters});Mn=[...Mn,{consumerTransport:i,serverConsumerTransportId:s.id,producerId:e,consumer:r}];const n=document.createElement("div");n.setAttribute("id",`td-${e}`),n.setAttribute("class","remoteVideo"),n.innerHTML='<video id="'+e+'" autoplay class="video" ></video>',xn=document.querySelector(".video-wrapper"),xn.appendChild(n);const{track:a}=r;console.log("remoteProducerId",e);const o=document.getElementById(e);o.srcObject=new MediaStream([a]),ye.emit("consumer-resume",{serverConsumerId:s.serverConsumerId})})},ol=["onClick"],cl={class:"left"},dl={key:0,class:"online-status"},pl={class:"right"},ll={class:"right-top"},ul={class:"user-name"},hl={class:"last-time"},fl={class:"last-message"},ml={class:"top"},gl={class:"cur-name"},_l={class:"cur-status"},wl={class:"top-call"},vl={key:0,"element-loading-background":"transparent",class:"loading"},bl={class:"bottom"},Sl={key:1,class:"empty"},yl=tr({__name:"Conversation",setup(i){const e=ie([]);let t=null;const s=La(),r=ie(),n=ie({x:20,y:20,width:630,height:410,isActive:!1}),a=ie(!1),o=ie([]);async function d(){const A=await ps.sendRequest("GetConversationList",{});o.value=A.list}Wr(()=>{d();const A=s.userInfo._id;t=Nn(`https://admin.dianlvtong.xyz?userId=${A}`),t.on("connect",()=>{console.log("connected")}),t.on("get-online-users",C=>{console.log("online users",C),e.value=C}),t.on("user-connected",C=>{console.log(`${C} connected`)}),t.on("new-message",C=>{console.log("new-message:",C),ls.playSound(ls.SOUND.NEW_MESSAGE),c.value.unshift(C),E()}),t.on("call-made",({callerId:C,callerName:W,callerAvatar:he,type:be})=>{console.log("call-made",C,W,he,be),r.value.showDialog({callerId:C,callerName:W,callerAvatar:he},be)}),t.on("call-canceled",({callerId:C,callerName:W})=>{console.log("call-canceled",C,W),Ni.error(`${W} 取消了通话`),r.value.hideDialog()}),t.on("answer-made",({callerId:C,answerType:W})=>{console.log("answer-made",C,W),W==="accept"&&(a.value=!0,r.value.hideCallDialog(),In()),W==="reject"&&(Ni.error("对方拒绝您的通话"),r.value.hideCallDialog())}),t.on("call-ended",({calleeId:C})=>{console.log("call-ended",C)})}),ya(()=>{t.connected&&t.disconnect(),b.value.removeEventListener("scroll",p)});const p=A=>{A.target.scrollHeight+A.target.scrollTop==b.value.offsetHeight&&f(g.value.receiver._id)},c=ie([]),u=ie(0),l=ie(!1),h=ie(!1),f=async A=>{if(l.value)return;h.value=!0,u.value++;const C={page:u.value,id:A},W=await ps.sendRequest("GetConversationMessageList",C);W.messages.length<10&&(l.value=!0),c.value=[...c.value,...W.messages],h.value=!1},g=ie(),m=async A=>{g.value=A,await f(A.receiver._id),E(),b.value.addEventListener("scroll",p)},w=ie(""),N=async()=>{if(w.value=="")return;const A={message:w.value,receiver_id:g.value.receiver._id},C=ie({message:w.value,create_time:new Date().getTime(),senderId:s.userInfo._id,receiverId:g.value.receiver._id,status:"pending"});c.value.unshift(C.value),await ps.sendRequest("CreateConversation",A,null,null)?C.value.status="success":C.value.status="failed",w.value="",E()},b=ie(),E=()=>{Ra(()=>{b.value.scrollTop=b.value.scrollHeight})},K=A=>{console.log(`Calling ${A}`),t.emit("call-user",{recipientId:g.value.receiver._id,name:g.value.receiver.name,avatar:g.value.receiver.avatar,type:A}),r.value.showCallDialog(g.value.receiver,A)},ee=A=>{const C=g.value.participants.find(W=>W._id===s.userInfo._id);t.emit("call-cancel",{recipientId:A._id,callerName:C.name})},ve=A=>{a.value=!0,In(),t.emit("answer-call",{recipientId:A.callerId,type:"accept"})},Te=A=>{console.log("Hangup",{recipientId:A.callerId}),t.emit("answer-call",{recipientId:A.callerId,type:"reject"})};return(A,C)=>{const W=ce("el-avatar"),he=ce("el-aside"),be=ce("el-icon"),qt=ce("el-input"),Ye=ce("el-button"),Qt=ce("el-main"),mt=ce("el-empty"),Ee=ce("el-container"),yr=Ca("loading");return ge(),cs(Ee,null,{default:q(()=>[k(he,{width:"320px",class:"chat-list"},{default:q(()=>[(ge(!0),Fe(Xr,null,On(o.value,(re,Rr)=>{var Ps,Es;return ge(),Fe("div",{key:Rr,class:"chat-item",onClick:_i=>m(re)},[V("div",cl,[k(W,{size:50,src:re.receiver.avatar},null,8,["src"]),e.value.includes(re.receiver._id)?(ge(),Fe("div",dl)):Js("",!0)]),V("div",pl,[V("div",ll,[V("div",ul,Be(re.receiver.name),1),V("div",hl,Be(De(ls).formatChatTime((Ps=re.messages[0])==null?void 0:Ps.create_time)),1)]),V("p",fl,Be((Es=re.messages.at(-1))==null?void 0:Es.message),1)])],8,ol)}),128))]),_:1}),g.value?(ge(),cs(Qt,{key:0,style:{padding:"0",position:"relative"}},{default:q(()=>[V("div",ml,[V("div",null,[V("div",gl,Be(g.value.receiver.name),1),V("div",_l,Be(e.value.includes(g.value.receiver._id)?"在线":"离线"),1)]),V("div",wl,[k(be,{size:"20",onClick:C[0]||(C[0]=re=>K("video"))},{default:q(()=>[k(De($n))]),_:1}),k(be,{size:"20",onClick:C[1]||(C[1]=re=>K("audio"))},{default:q(()=>[k(De(jn))]),_:1})])]),V("div",{class:"content-list",ref_key:"contentListRef",ref:b},[h.value?Da((ge(),Fe("div",vl,null,512)),[[yr,h.value]]):Js("",!0),k(Ma,{messages:c.value,curConversation:g.value},null,8,["messages","curConversation"])],512),V("div",bl,[k(qt,{modelValue:w.value,"onUpdate:modelValue":C[2]||(C[2]=re=>w.value=re),size:"large",placeholder:"请输入消息",onKeyup:Ta(N,["enter"])},null,8,["modelValue"]),k(Ye,{disabled:w.value==="",type:"primary",size:"large",onClick:N},{default:q(()=>C[8]||(C[8]=[ds("发送")])),_:1},8,["disabled"])])]),_:1})):(ge(),Fe("div",Sl,[k(mt,{description:"选择一个对话开始聊天吧"})])),k(za,{ref_key:"callDialogRef",ref:r,onHangupByCaller:ee,onAnswer:ve,onHangup:Te},null,512),a.value?(ge(),cs(De(Ia),{key:2,x:n.value.x,"onUpdate:x":C[3]||(C[3]=re=>n.value.x=re),y:n.value.y,"onUpdate:y":C[4]||(C[4]=re=>n.value.y=re),h:n.value.height,"onUpdate:h":C[5]||(C[5]=re=>n.value.height=re),w:n.value.width,"onUpdate:w":C[6]||(C[6]=re=>n.value.width=re),active:n.value.isActive,"onUpdate:active":C[7]||(C[7]=re=>n.value.isActive=re),parent:!0,resizable:!1},{default:q(()=>C[9]||(C[9]=[V("div",{class:"video-wrapper"},[V("video",{id:"local-video",autoplay:""})],-1)])),_:1},8,["x","y","h","w","active"])):Js("",!0)]),_:1})}}});const Rl=Yr(yl,[["__scopeId","data-v-c11a091a"]]);const Cl={key:0,class:"chat-wrapper"},Dl={class:"custom-tabs-label"},Tl={class:"custom-tabs-label"},Pl={class:"custom-tabs-label"},El=tr({__name:"index",setup(i){const e=ie("chat");return Wr(()=>{console.log("GlobalFunction.getPlatform()",ls.getPlatform())}),(t,s)=>{const r=ce("el-icon"),n=ce("el-tab-pane"),a=ce("el-tabs");return De(ls).getPlatform()=="1pc"?(ge(),Fe("div",Cl,[k(a,{modelValue:e.value,"onUpdate:modelValue":s[0]||(s[0]=o=>e.value=o),"tab-position":"left",class:"demo-tabs"},{default:q(()=>[k(n,{name:"chat"},{label:q(()=>[V("span",Dl,[k(r,{size:"20"},{default:q(()=>[k(De(kn))]),_:1}),s[1]||(s[1]=V("span",null,"聊天",-1))])]),default:q(()=>[k(Rl)]),_:1}),k(n,{name:"contact"},{label:q(()=>[V("span",Tl,[k(r,{size:"20"},{default:q(()=>[k(De(Pa))]),_:1}),s[2]||(s[2]=V("span",null,"联系人",-1))])]),default:q(()=>[k(Na)]),_:1}),k(n,{name:"setting"},{label:q(()=>[V("span",Pl,[k(r,{size:"20"},{default:q(()=>[k(De(Ea))]),_:1}),s[3]||(s[3]=V("span",null,"设置",-1))])]),default:q(()=>[s[4]||(s[4]=ds(" 设置 "))]),_:1})]),_:1},8,["modelValue"])])):(ge(),cs(xa,{key:1}))}}});const Hl=Yr(El,[["__scopeId","data-v-410e206b"]]);export{Hl as default};
